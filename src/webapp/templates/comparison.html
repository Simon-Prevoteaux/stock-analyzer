{% extends "base.html" %}

{% block title %}Stock Comparison{% endblock %}

{% block content %}
<h1>Compare Stocks</h1>

<div class="comparison-search">
    <form method="GET" id="comparison-form">
        <div class="form-group">
            <label for="ticker-search">Search and select stocks to compare:</label>
            <div class="search-container">
                <input type="text"
                       id="ticker-search"
                       placeholder="Type ticker symbol (e.g., AAPL, MSFT)..."
                       autocomplete="off">
                <input type="hidden" name="tickers" id="tickers-hidden" value="">
                <div class="search-results" id="search-results"></div>
            </div>
        </div>

        <div class="selected-stocks" id="selected-stocks">
            <div class="selected-label">Selected stocks:</div>
            <div class="selected-chips" id="selected-chips"></div>
        </div>

        <div class="comparison-actions">
            <button type="submit" class="btn btn-primary" id="compare-btn" disabled>Compare</button>
            <button type="button" class="btn btn-secondary" id="clear-btn" style="display: none;">Clear All</button>
        </div>
    </form>
</div>

<script src="{{ url_for('static', filename='js/comparison.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const availableStocks = {{ available_stocks | tojson | safe }};
    initializeComparisonSearch(availableStocks);
});
</script>


<div class="comparison-suggestions">
    <h2>Quick Comparison Groups</h2>
    <p class="subtitle">Select a pre-defined group to compare</p>

    <div class="suggestions-grid">
        {% for sugg_id, sugg_data in suggestions.items() %}
        {% if sugg_data.tickers %}
        <div class="suggestion-card">
            <h4>{{ sugg_data.name }}</h4>
            <p class="description">{{ sugg_data.description }}</p>
            <p class="ticker-preview">{{ sugg_data.tickers[:5]|join(', ') }}{% if sugg_data.tickers|length > 5 %}...{% endif %}</p>
            <button type="button" class="btn btn-sm btn-secondary" onclick="compareTickers('{{ sugg_data.tickers|join(',') }}')">
                Compare These
            </button>
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>


{% if stocks %}
<div class="comparison-table-container">
    <table class="comparison-table">
        <thead>
            <tr>
                <th>Metric</th>
                {% for stock in stocks %}
                <th><a href="{{ url_for('core.stock_detail', ticker=stock.ticker) }}" style="color: #00ff88; text-decoration: none;">{{ stock.ticker }}</a></th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            <!-- Basic Info -->
            <tr>
                <td><strong>Company Name</strong></td>
                {% for stock in stocks %}
                <td>{{ stock.company_name }}</td>
                {% endfor %}
            </tr>
            <tr>
                <td><strong>Sector</strong></td>
                {% for stock in stocks %}
                <td>{{ stock.sector }}</td>
                {% endfor %}
            </tr>

            <!-- Valuation Metrics Section -->
            <tr class="section-header">
                <td colspan="{{ stocks|length + 1 }}"><h3>Valuation Metrics</h3></td>
            </tr>
            <tr>
                <td><strong>Market Cap</strong></td>
                {% for stock in stocks %}
                <td>{{ stock.market_cap|format_number }}</td>
                {% endfor %}
            </tr>
            <tr>
                <td><strong>Enterprise Value</strong></td>
                {% for stock in stocks %}
                <td>{{ stock.enterprise_value|format_number }}</td>
                {% endfor %}
            </tr>
            <tr>
                <td><strong>Current Price</strong></td>
                {% for stock in stocks %}
                <td>${{ stock.current_price }}</td>
                {% endfor %}
            </tr>
            <tr>
                <td><strong>Target Price</strong></td>
                {% for stock in stocks %}
                <td>{% if stock.target_price and stock.target_price > 0 %}${{ "%.2f"|format(stock.target_price) }}{% else %}N/A{% endif %}</td>
                {% endfor %}
            </tr>
            <tr>
                <td><strong>P/E Ratio</strong></td>
                {% for stock in stocks %}
                <td>{{ stock.pe_ratio|format_ratio }}</td>
                {% endfor %}
            </tr>
            <tr>
                <td><strong>Forward P/E</strong></td>
                {% for stock in stocks %}
                <td>{{ stock.forward_pe|format_ratio }}</td>
                {% endfor %}
            </tr>
            <tr>
                <td><strong>P/S Ratio</strong></td>
                {% for stock in stocks %}
                <td>{{ stock.ps_ratio|format_ratio }}</td>
                {% endfor %}
            </tr>
            <tr>
                <td><strong>Price to Book</strong></td>
                {% for stock in stocks %}
                <td>{{ stock.price_to_book|format_ratio }}</td>
                {% endfor %}
            </tr>

            <!-- Financial Metrics Section -->
            <tr class="section-header">
                <td colspan="{{ stocks|length + 1 }}"><h3>Financial Metrics</h3></td>
            </tr>
            <tr>
                <td><strong>Revenue</strong></td>
                {% for stock in stocks %}
                <td>{{ stock.revenue|format_number }}</td>
                {% endfor %}
            </tr>
            <tr>
                <td><strong>EPS</strong></td>
                {% for stock in stocks %}
                <td>${{ stock.eps }}</td>
                {% endfor %}
            </tr>
            <tr>
                <td><strong>Profit Margin</strong></td>
                {% for stock in stocks %}
                <td>{{ stock.profit_margin|format_percent }}</td>
                {% endfor %}
            </tr>
            <tr>
                <td><strong>Free Cash Flow</strong></td>
                {% for stock in stocks %}
                <td>{{ stock.free_cash_flow|format_number }}</td>
                {% endfor %}
            </tr>
            <tr>
                <td><strong>Current Ratio</strong></td>
                {% for stock in stocks %}
                <td>{{ stock.current_ratio|format_ratio }}</td>
                {% endfor %}
            </tr>

            <!-- Growth & Risk Section -->
            <tr class="section-header">
                <td colspan="{{ stocks|length + 1 }}"><h3>Growth & Risk</h3></td>
            </tr>
            <tr>
                <td><strong>Revenue Growth</strong></td>
                {% for stock in stocks %}
                <td>{{ stock.revenue_growth|format_percent }}</td>
                {% endfor %}
            </tr>
            <tr>
                <td><strong>Earnings Growth</strong></td>
                {% for stock in stocks %}
                <td>{{ stock.earnings_growth|format_percent }}</td>
                {% endfor %}
            </tr>
            <tr>
                <td><strong>Profitable</strong></td>
                {% for stock in stocks %}
                <td>{% if stock.is_profitable %}Yes{% else %}No{% endif %}</td>
                {% endfor %}
            </tr>
            <tr>
                <td>
                    <strong>Bubble Score</strong>
                    <button type="button" class="info-btn" onclick="showInfo('bubble-score')">i</button>
                </td>
                {% for stock in stocks %}
                <td>{{ stock.bubble_score }}/10</td>
                {% endfor %}
            </tr>
            <tr>
                <td>
                    <strong>Risk Level</strong>
                    <button type="button" class="info-btn" onclick="showInfo('risk-level')">i</button>
                </td>
                {% for stock in stocks %}
                <td><span class="risk-badge risk-{{ stock.risk_level|lower|replace(' ', '-') }}">{{ stock.risk_level }}</span></td>
                {% endfor %}
            </tr>

            <!-- Growth Analysis Section -->
            {% if growth_metrics_list and growth_metrics_list|length > 0 %}
            <tr class="section-header">
                <td colspan="{{ stocks|length + 1 }}"><h3>Growth Analysis</h3></td>
            </tr>
            <tr>
                <td>
                    <strong>Revenue CAGR (3Y)</strong>
                    <button type="button" class="info-btn" onclick="showInfo('revenue-cagr')">i</button>
                </td>
                {% for metrics in growth_metrics_list %}
                <td>{% if metrics.get('revenue_cagr_3y') %}{{ metrics.revenue_cagr_3y|format_percent }}{% else %}N/A{% endif %}</td>
                {% endfor %}
            </tr>
            <tr>
                <td>
                    <strong>Earnings CAGR (3Y)</strong>
                    <button type="button" class="info-btn" onclick="showInfo('earnings-cagr')">i</button>
                </td>
                {% for metrics in growth_metrics_list %}
                <td>{% if metrics.get('earnings_cagr_3y') %}{{ metrics.earnings_cagr_3y|format_percent }}{% else %}N/A{% endif %}</td>
                {% endfor %}
            </tr>
            <tr>
                <td>
                    <strong>Revenue Consistency</strong>
                    <button type="button" class="info-btn" onclick="showInfo('revenue-consistency')">i</button>
                </td>
                {% for metrics in growth_metrics_list %}
                <td>
                    {% if metrics.get('revenue_consistency_score') %}
                    <span class="consistency-score-{{ 'high' if metrics.revenue_consistency_score >= 70 else 'medium' if metrics.revenue_consistency_score >= 50 else 'low' }}">
                        {{ metrics.revenue_consistency_score|round(0)|int }}/100
                    </span>
                    {% else %}N/A{% endif %}
                </td>
                {% endfor %}
            </tr>
            <tr>
                <td>
                    <strong>Earnings Consistency</strong>
                    <button type="button" class="info-btn" onclick="showInfo('earnings-consistency')">i</button>
                </td>
                {% for metrics in growth_metrics_list %}
                <td>
                    {% if metrics.get('earnings_consistency_score') %}
                    <span class="consistency-score-{{ 'high' if metrics.earnings_consistency_score >= 70 else 'medium' if metrics.earnings_consistency_score >= 50 else 'low' }}">
                        {{ metrics.earnings_consistency_score|round(0)|int }}/100
                    </span>
                    {% else %}N/A{% endif %}
                </td>
                {% endfor %}
            </tr>
            <tr>
                <td>
                    <strong>Profitable Quarters</strong>
                    <button type="button" class="info-btn" onclick="showInfo('profitable-quarters')">i</button>
                </td>
                {% for metrics in growth_metrics_list %}
                <td>{% if metrics.get('consecutive_profitable_quarters') %}{{ metrics.consecutive_profitable_quarters }} consecutive{% else %}N/A{% endif %}</td>
                {% endfor %}
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>
{% elif request.args.get('tickers') %}
<p class="no-results">No stocks found for the provided tickers.</p>
{% endif %}

<!-- Info Modal -->
<div class="info-modal-overlay" id="info-modal-overlay" onclick="closeInfo()">
    <div class="info-modal" onclick="event.stopPropagation()">
        <button class="info-modal-close" onclick="closeInfo()">&times;</button>
        <h3 id="info-modal-title"></h3>
        <div id="info-modal-content"></div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/modal.js') }}"></script>


{% endblock %}
