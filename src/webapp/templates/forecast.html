{% extends "base.html" %}

{% block title %}Stock Forecast{% endblock %}

{% block content %}
<h1>Stock Price Forecast</h1>

<div class="forecast-selector">
    <form method="GET" class="stock-select-form" id="stock-search-form">
        <div class="form-group">
            <label for="ticker-search">Search for a Stock:</label>
            <div class="search-container">
                <input type="text"
                       id="ticker-search"
                       placeholder="Type ticker symbol (e.g., AAPL, MSFT)..."
                       autocomplete="off"
                       value="{{ selected_ticker or '' }}">
                <input type="hidden" name="ticker" id="ticker-hidden" value="{{ selected_ticker or '' }}">
                <div class="search-results" id="search-results"></div>
            </div>
        </div>
    </form>
</div>

<script>
(function() {
    const availableStocks = {{ available_stocks | tojson | safe }};
    const searchInput = document.getElementById('ticker-search');
    const hiddenInput = document.getElementById('ticker-hidden');
    const resultsDiv = document.getElementById('search-results');
    const form = document.getElementById('stock-search-form');

    searchInput.addEventListener('input', function() {
        const query = this.value.toUpperCase().trim();
        resultsDiv.innerHTML = '';

        if (query.length === 0) {
            resultsDiv.style.display = 'none';
            return;
        }

        const matches = availableStocks.filter(stock =>
            stock.toUpperCase().includes(query)
        ).slice(0, 10);

        if (matches.length > 0) {
            resultsDiv.style.display = 'block';
            matches.forEach(stock => {
                const div = document.createElement('div');
                div.className = 'search-result-item';
                div.textContent = stock;
                div.addEventListener('click', function() {
                    searchInput.value = stock;
                    hiddenInput.value = stock;
                    resultsDiv.style.display = 'none';
                    form.submit();
                });
                resultsDiv.appendChild(div);
            });
        } else {
            resultsDiv.style.display = 'none';
        }
    });

    searchInput.addEventListener('keydown', function(e) {
        const items = resultsDiv.querySelectorAll('.search-result-item');
        const active = resultsDiv.querySelector('.search-result-item.active');

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (!active && items.length > 0) {
                items[0].classList.add('active');
            } else if (active && active.nextElementSibling) {
                active.classList.remove('active');
                active.nextElementSibling.classList.add('active');
            }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (active && active.previousElementSibling) {
                active.classList.remove('active');
                active.previousElementSibling.classList.add('active');
            }
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (active) {
                searchInput.value = active.textContent;
                hiddenInput.value = active.textContent;
                resultsDiv.style.display = 'none';
                form.submit();
            } else if (availableStocks.includes(searchInput.value.toUpperCase())) {
                hiddenInput.value = searchInput.value.toUpperCase();
                form.submit();
            }
        } else if (e.key === 'Escape') {
            resultsDiv.style.display = 'none';
        }
    });

    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
            resultsDiv.style.display = 'none';
        }
    });
})();
</script>

{% if error %}
<div class="alert alert-error">
    {{ error }}
</div>
{% endif %}

{% if results %}
<div class="forecast-header">
    <h2>{{ results.company_name }} ({{ results.ticker }})</h2>
    <div class="current-price">
        <span class="label">Current Price:</span>
        <span class="value">${{ "%.2f"|format(results.current_price) }}</span>
    </div>
    <div class="header-actions">
        <a href="{{ url_for('stock_detail', ticker=results.ticker) }}" class="btn btn-secondary">View Details</a>
    </div>
</div>

<!-- Growth Rate Source Info -->
{% if growth_rate_info %}
<div class="growth-rate-info">
    <h3>üìä Growth Rate Sources</h3>
    {% if growth_rate_info.has_historical_data %}
    <div class="growth-info-banner historical">
        <span class="badge-historical">‚úì Using Historical Data</span>
        <p>Forecasts are using multi-year historical averages instead of single-point estimates</p>
    </div>
    {% else %}
    <div class="growth-info-banner fallback">
        <span class="badge-fallback">‚ö† Using Single-Point Data</span>
        <p>No historical data available - using yfinance current values. Fetch historical data for more accurate forecasts.</p>
    </div>
    {% endif %}

    <div class="growth-metrics-grid">
        <div class="growth-metric-card">
            <h4>Revenue Growth Rate</h4>
            <div class="metric-value">{{ (growth_rate_info.revenue_growth_used * 100)|round(1) }}%</div>
            <div class="metric-source">
                <span class="source-label">Source:</span>
                <span class="source-value {{ 'historical' if 'Historical' in growth_rate_info.revenue_source else 'fallback' }}">
                    {{ growth_rate_info.revenue_source }}
                </span>
            </div>
            {% if growth_rate_info.revenue_cagr_3y %}
            <div class="metric-detail">3Y CAGR: {{ (growth_rate_info.revenue_cagr_3y * 100)|round(1) }}%</div>
            {% endif %}
        </div>

        <div class="growth-metric-card">
            <h4>Earnings Growth Rate</h4>
            <div class="metric-value">{{ (growth_rate_info.earnings_growth_used * 100)|round(1) }}%</div>
            <div class="metric-source">
                <span class="source-label">Source:</span>
                <span class="source-value {{ 'historical' if 'Historical' in growth_rate_info.earnings_source else 'fallback' }}">
                    {{ growth_rate_info.earnings_source }}
                </span>
            </div>
            {% if growth_rate_info.earnings_cagr_3y %}
            <div class="metric-detail">3Y CAGR: {{ (growth_rate_info.earnings_cagr_3y * 100)|round(1) }}%</div>
            {% endif %}
        </div>

        {% if growth_rate_info.consistency_score %}
        <div class="growth-metric-card">
            <h4>Growth Consistency</h4>
            <div class="metric-value consistency-{{ 'high' if growth_rate_info.consistency_score >= 70 else 'medium' if growth_rate_info.consistency_score >= 50 else 'low' }}">
                {{ growth_rate_info.consistency_score|round(0)|int }}
            </div>
            <div class="metric-source">
                <span class="source-label">Quality Score:</span>
                <span class="source-value">
                    {{ 'High Quality' if growth_rate_info.consistency_score >= 70 else 'Medium Quality' if growth_rate_info.consistency_score >= 50 else 'Variable' }}
                </span>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Hidden form to maintain state -->
<form method="GET" id="forecast-form" style="display: none;">
    <input type="hidden" name="ticker" id="form-ticker" value="{{ selected_ticker }}">
    <input type="hidden" name="years" id="form-years" value="{{ request.args.get('years', 5) }}">
    <input type="hidden" name="earnings_growth" id="form-earnings_growth" value="{{ request.args.get('earnings_growth', results.earnings_model.details.get('initial_growth_rate', 15) / 100 if results else 0.15) }}">
    <input type="hidden" name="terminal_pe" id="form-terminal_pe" value="{{ request.args.get('terminal_pe', results.earnings_model.details.get('terminal_pe', 20) if results else 20) }}">
    <input type="hidden" name="revenue_growth" id="form-revenue_growth" value="{{ request.args.get('revenue_growth', results.revenue_model.details.get('initial_growth_rate', 20) / 100 if results else 0.20) }}">
    <input type="hidden" name="terminal_ps" id="form-terminal_ps" value="{{ request.args.get('terminal_ps', results.revenue_model.details.get('terminal_ps', 5) if results else 5) }}">
    <input type="hidden" name="fcf_growth" id="form-fcf_growth" value="{{ request.args.get('fcf_growth', 0.10) }}">
    <input type="hidden" name="discount_rate" id="form-discount_rate" value="{{ request.args.get('discount_rate', 0.10) }}">
    <input type="hidden" name="volatility" id="form-volatility" value="{{ request.args.get('volatility', 0.30) }}">
</form>

<!-- Valuation Multiples Info -->
{% if results %}
<div class="valuation-multiples-section">
    <h3>üìà Current Valuation Multiples</h3>
    <p class="section-description">Understanding these multiples helps set realistic terminal values in your forecasts</p>

    <div class="multiples-grid">
        <!-- P/E Ratio Card -->
        <div class="multiple-card">
            <h4>Price-to-Earnings (P/E)</h4>
            <div class="multiple-main-value">
                <span class="label">Trailing P/E:</span>
                <span class="value pe-{{ 'low' if stock.pe_ratio < 15 else 'medium' if stock.pe_ratio < 25 else 'high' if stock.pe_ratio < 40 else 'very-high' }}">
                    {{ stock.pe_ratio|round(1) if stock.pe_ratio else 'N/A' }}x
                </span>
            </div>
            {% if stock.forward_pe and stock.forward_pe > 0 %}
            <div class="multiple-secondary">
                <span class="label">Forward P/E:</span>
                <span class="value">{{ stock.forward_pe|round(1) }}x</span>
            </div>
            {% endif %}
            <div class="multiple-guide">
                <strong>Quick Guide:</strong>
                <ul>
                    <li>&lt;15: Value territory</li>
                    <li>15-25: Fairly valued</li>
                    <li>25-40: Growth premium</li>
                    <li>&gt;40: High expectations</li>
                </ul>
            </div>
            <div class="multiple-recommendation">
                {% if stock.pe_ratio < 15 %}
                <span class="rec-badge rec-conservative">Conservative terminal P/E: 12-18x</span>
                {% elif stock.pe_ratio < 25 %}
                <span class="rec-badge rec-moderate">Moderate terminal P/E: 15-22x</span>
                {% elif stock.pe_ratio < 40 %}
                <span class="rec-badge rec-growth">Growth terminal P/E: 20-30x</span>
                {% else %}
                <span class="rec-badge rec-aggressive">High terminal P/E: 25-35x (risky)</span>
                {% endif %}
            </div>
        </div>

        <!-- P/S Ratio Card -->
        <div class="multiple-card">
            <h4>Price-to-Sales (P/S)</h4>
            <div class="multiple-main-value">
                <span class="label">Current P/S:</span>
                <span class="value ps-{{ 'low' if stock.ps_ratio < 3 else 'medium' if stock.ps_ratio < 10 else 'high' if stock.ps_ratio < 20 else 'very-high' }}">
                    {{ stock.ps_ratio|round(1) if stock.ps_ratio else 'N/A' }}x
                </span>
            </div>
            {% if stock.profit_margin %}
            <div class="multiple-secondary">
                <span class="label">Profit Margin:</span>
                <span class="value">{{ (stock.profit_margin * 100)|round(1) }}%</span>
            </div>
            {% endif %}
            <div class="multiple-guide">
                <strong>Quick Guide:</strong>
                <ul>
                    <li>&lt;3: Value/Traditional</li>
                    <li>3-10: Moderate growth</li>
                    <li>10-20: High growth</li>
                    <li>&gt;20: Very high expectations</li>
                </ul>
            </div>
            <div class="multiple-recommendation">
                {% if stock.ps_ratio < 3 %}
                <span class="rec-badge rec-conservative">Conservative terminal P/S: 2-4x</span>
                {% elif stock.ps_ratio < 10 %}
                <span class="rec-badge rec-moderate">Moderate terminal P/S: 4-8x</span>
                {% elif stock.ps_ratio < 20 %}
                <span class="rec-badge rec-growth">Growth terminal P/S: 6-15x</span>
                {% else %}
                <span class="rec-badge rec-aggressive">High terminal P/S: 10-20x (risky)</span>
                {% endif %}
            </div>
        </div>

        <!-- Price-to-Book Card (if available) -->
        {% if stock.price_to_book and stock.price_to_book > 0 %}
        <div class="multiple-card">
            <h4>Price-to-Book (P/B)</h4>
            <div class="multiple-main-value">
                <span class="label">Current P/B:</span>
                <span class="value pb-{{ 'low' if stock.price_to_book < 2 else 'medium' if stock.price_to_book < 5 else 'high' }}">
                    {{ stock.price_to_book|round(1) }}x
                </span>
            </div>
            <div class="multiple-guide">
                <strong>Quick Guide:</strong>
                <ul>
                    <li>&lt;1: Below book value</li>
                    <li>1-3: Reasonable</li>
                    <li>3-5: Premium</li>
                    <li>&gt;5: High intangible value</li>
                </ul>
            </div>
        </div>
        {% endif %}

        <!-- Valuation Classification -->
        <div class="multiple-card classification-card">
            <h4>Valuation Assessment</h4>
            {% set is_value = stock.pe_ratio < 20 and stock.ps_ratio < 3 %}
            {% set is_growth = stock.pe_ratio > 25 or stock.ps_ratio > 10 %}
            {% set is_premium = stock.pe_ratio > 40 or stock.ps_ratio > 20 %}

            <div class="classification-result">
                {% if is_premium %}
                <div class="classification-badge premium">
                    <span class="icon">üöÄ</span>
                    <span class="text">Premium Valuation</span>
                </div>
                <p class="classification-desc">Market expects exceptional growth. Use aggressive assumptions carefully.</p>
                {% elif is_growth %}
                <div class="classification-badge growth">
                    <span class="icon">üìà</span>
                    <span class="text">Growth Valuation</span>
                </div>
                <p class="classification-desc">Market expects strong growth. Validate growth assumptions.</p>
                {% elif is_value %}
                <div class="classification-badge value">
                    <span class="icon">üíé</span>
                    <span class="text">Value Territory</span>
                </div>
                <p class="classification-desc">Trading at attractive multiples. Consider conservative terminal values.</p>
                {% else %}
                <div class="classification-badge fair">
                    <span class="icon">‚öñÔ∏è</span>
                    <span class="text">Fairly Valued</span>
                </div>
                <p class="classification-desc">Trading near market averages. Use moderate assumptions.</p>
                {% endif %}
            </div>

            <div class="sector-context">
                <span class="label">Sector:</span>
                <span class="value">{{ stock.sector }}</span>
            </div>
        </div>
    </div>

    <div class="multiples-tips">
        <h4>üí° Tips for Setting Terminal Multiples</h4>
        <div class="tips-grid">
            <div class="tip-item">
                <strong>Mean Reversion:</strong> High-growth stocks typically see P/E compress toward market average (15-20x) over time
            </div>
            <div class="tip-item">
                <strong>Sustainable Growth:</strong> Terminal P/E should reflect long-term sustainable growth (not peak growth)
            </div>
            <div class="tip-item">
                <strong>Sector Context:</strong> Tech/growth sectors justify higher multiples than mature industries
            </div>
            <div class="tip-item">
                <strong>Conservative Approach:</strong> When in doubt, use lower terminal multiples for a margin of safety
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Scenario Analysis -->
<div class="forecast-section scenarios-section">
    <div class="scenarios-header">
        <div>
            <h2>Scenario Analysis <button type="button" class="info-btn" onclick="showInfo('scenario-analysis')">i</button></h2>
            <p class="subtitle">Bull, Base, and Bear case projections</p>
        </div>
        <div class="param-item">
            <label for="years">Forecast Years: <button type="button" class="info-btn info-btn-sm" onclick="showInfo('forecast-years')">i</button></label>
            <input type="range" id="years" name="years" min="1" max="10" value="{{ request.args.get('years', 5) }}" oninput="updateParam('years', this.value, this.value + ' years')">
            <span id="years-label">{{ request.args.get('years', 5) }} years</span>
        </div>
    </div>

    <div class="scenarios-grid">
        {% for scenario_name, scenario in results.scenarios.scenarios.items() %}
        <div class="scenario-card scenario-{{ scenario_name }}">
            <h3>{{ scenario_name|upper }} Case</h3>
            <div class="target-price">${{ "%.2f"|format(scenario.target_price) }}</div>
            <div class="upside {% if scenario.upside_percent >= 0 %}positive{% else %}negative{% endif %}">
                {{ "%.1f"|format(scenario.upside_percent) }}%
            </div>
            <div class="scenario-details">
                <p>Growth: {{ scenario.growth_rate }}%/yr</p>
                {% if scenario.terminal_pe %}
                <p>P/E: {{ scenario.terminal_pe }}x</p>
                {% endif %}
                {% if scenario.terminal_ps %}
                <p>P/S: {{ scenario.terminal_ps }}x</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Model Results Grid -->
<div class="models-grid">
    <!-- Earnings Growth Model -->
    <div class="model-card">
        <h3>Earnings Growth Model <button type="button" class="info-btn" onclick="showInfo('earnings-model-detail')">i</button></h3>
        {% if results.earnings_model.details.get('error') %}
        <p class="model-error">{{ results.earnings_model.details.error }}</p>
        {% else %}
        <div class="model-result">
            <div class="target-price">${{ "%.2f"|format(results.earnings_model.target_price) }}</div>
            <div class="upside {% if results.earnings_model.upside_percent >= 0 %}positive{% else %}negative{% endif %}">
                {{ "%.1f"|format(results.earnings_model.upside_percent) }}% upside
            </div>
            <div class="annual-return">
                {{ "%.1f"|format(results.earnings_model.annual_return) }}% annual return
            </div>
        </div>

        <div class="model-params">
            <h4>Adjust Parameters</h4>
            {% if growth_rate_info and growth_rate_info.earnings_sources|length > 1 %}
            <div class="param-item">
                <label for="earnings_source_selector">Growth Rate Source:</label>
                <select id="earnings_source_selector" onchange="selectEarningsSource(this.value)" class="source-selector">
                    {% for source in growth_rate_info.earnings_sources %}
                    <option value="{{ source.value }}" data-key="{{ source.key }}" {% if (source.value - (request.args.get('earnings_growth')|float or results.earnings_model.details.get('initial_growth_rate', 15) / 100))|abs < 0.001 %}selected{% endif %}>{{ source.label }} ({{ (source.value * 100)|round(1) }}%)</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            <div class="param-item">
                <label for="earnings_growth">EPS Growth Rate: <button type="button" class="info-btn info-btn-sm" onclick="showInfo('eps-growth')">i</button></label>
                <input type="range" id="earnings_growth" name="earnings_growth" min="0" max="0.5" step="0.01" value="{{ request.args.get('earnings_growth', results.earnings_model.details.get('initial_growth_rate', 15) / 100) }}" oninput="updateParam('earnings_growth', this.value, Math.round(this.value * 100) + '%')">
                <span id="earnings_growth-label">{{ "%.0f"|format((request.args.get('earnings_growth', results.earnings_model.details.get('initial_growth_rate', 15) / 100)|float) * 100) }}%</span>
            </div>
            <div class="param-item">
                <label for="terminal_pe">Terminal P/E: <button type="button" class="info-btn info-btn-sm" onclick="showInfo('terminal-pe')">i</button></label>
                <input type="range" id="terminal_pe" name="terminal_pe" min="5" max="50" step="1" value="{{ request.args.get('terminal_pe', results.earnings_model.details.get('terminal_pe', 20)) }}" oninput="updateParam('terminal_pe', this.value, this.value + 'x')">
                <span id="terminal_pe-label">{{ request.args.get('terminal_pe', results.earnings_model.details.get('terminal_pe', 20)) }}x</span>
            </div>
            <button type="button" class="btn-update" onclick="submitForecastForm()">Update</button>
        </div>

        <div class="model-details">
            <table>
                <tr><td>Starting EPS</td><td>${{ results.earnings_model.details.starting_eps }}</td></tr>
                <tr><td>Ending EPS</td><td>${{ results.earnings_model.details.ending_eps }}</td></tr>
                <tr><td>Growth Rate</td><td>{{ results.earnings_model.details.initial_growth_rate }}%</td></tr>
                <tr><td>Growth Decay</td><td>{{ results.earnings_model.details.growth_decay }}%/yr</td></tr>
                <tr><td>Terminal P/E</td><td>{{ results.earnings_model.details.terminal_pe }}x</td></tr>
            </table>
        </div>
        {% endif %}
    </div>

    <!-- Revenue Growth Model -->
    <div class="model-card">
        <h3>Revenue Growth Model <button type="button" class="info-btn" onclick="showInfo('revenue-model-detail')">i</button></h3>
        {% if results.revenue_model.details.get('error') %}
        <p class="model-error">{{ results.revenue_model.details.error }}</p>
        {% else %}
        <div class="model-result">
            <div class="target-price">${{ "%.2f"|format(results.revenue_model.target_price) }}</div>
            <div class="upside {% if results.revenue_model.upside_percent >= 0 %}positive{% else %}negative{% endif %}">
                {{ "%.1f"|format(results.revenue_model.upside_percent) }}% upside
            </div>
            <div class="annual-return">
                {{ "%.1f"|format(results.revenue_model.annual_return) }}% annual return
            </div>
        </div>

        <div class="model-params">
            <h4>Adjust Parameters</h4>
            {% if growth_rate_info and growth_rate_info.revenue_sources|length > 1 %}
            <div class="param-item">
                <label for="revenue_source_selector">Growth Rate Source:</label>
                <select id="revenue_source_selector" onchange="selectRevenueSource(this.value)" class="source-selector">
                    {% for source in growth_rate_info.revenue_sources %}
                    <option value="{{ source.value }}" data-key="{{ source.key }}" {% if (source.value - (request.args.get('revenue_growth')|float or results.revenue_model.details.get('initial_growth_rate', 20) / 100))|abs < 0.001 %}selected{% endif %}>{{ source.label }} ({{ (source.value * 100)|round(1) }}%)</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            <div class="param-item">
                <label for="revenue_growth">Revenue Growth Rate: <button type="button" class="info-btn info-btn-sm" onclick="showInfo('eps-growth')">i</button></label>
                <input type="range" id="revenue_growth" name="revenue_growth" min="0" max="0.5" step="0.01" value="{{ request.args.get('revenue_growth', results.revenue_model.details.get('initial_growth_rate', 20) / 100) }}" oninput="updateParam('revenue_growth', this.value, Math.round(this.value * 100) + '%')">
                <span id="revenue_growth-label">{{ "%.0f"|format((request.args.get('revenue_growth', results.revenue_model.details.get('initial_growth_rate', 20) / 100)|float) * 100) }}%</span>
            </div>
            <div class="param-item">
                <label for="terminal_ps">Terminal P/S: <button type="button" class="info-btn info-btn-sm" onclick="showInfo('terminal-pe')">i</button></label>
                <input type="range" id="terminal_ps" name="terminal_ps" min="1" max="20" step="0.5" value="{{ request.args.get('terminal_ps', results.revenue_model.details.get('terminal_ps', 5)) }}" oninput="updateParam('terminal_ps', this.value, this.value + 'x')">
                <span id="terminal_ps-label">{{ request.args.get('terminal_ps', results.revenue_model.details.get('terminal_ps', 5)) }}x</span>
            </div>
            <button type="button" class="btn-update" onclick="submitForecastForm()">Update</button>
        </div>

        <div class="model-details">
            <table>
                <tr><td>Starting Revenue</td><td>{{ results.revenue_model.details.starting_revenue|format_number }}</td></tr>
                <tr><td>Ending Revenue</td><td>{{ results.revenue_model.details.ending_revenue|format_number }}</td></tr>
                <tr><td>Revenue CAGR</td><td>{{ results.revenue_model.details.revenue_cagr }}%</td></tr>
                <tr><td>Terminal P/S</td><td>{{ results.revenue_model.details.terminal_ps }}x</td></tr>
                <tr><td>Target Margin</td><td>{{ results.revenue_model.details.target_margin }}%</td></tr>
            </table>
        </div>
        {% endif %}
    </div>

    <!-- DCF Model -->
    <div class="model-card">
        <h3>DCF Model <button type="button" class="info-btn" onclick="showInfo('dcf-model-detail')">i</button></h3>
        {% if results.dcf_model.details.get('error') %}
        <p class="model-error">{{ results.dcf_model.details.error }}</p>
        {% else %}
        <div class="model-result">
            <div class="target-price">${{ "%.2f"|format(results.dcf_model.target_price) }}</div>
            <div class="upside {% if results.dcf_model.upside_percent >= 0 %}positive{% else %}negative{% endif %}">
                {{ "%.1f"|format(results.dcf_model.upside_percent) }}% upside
            </div>
            <div class="annual-return">
                {{ "%.1f"|format(results.dcf_model.annual_return) }}% annual return
            </div>
        </div>

        <div class="model-params">
            <h4>Adjust Parameters</h4>
            <div class="param-item">
                <label for="fcf_growth">FCF Growth: <button type="button" class="info-btn info-btn-sm" onclick="showInfo('fcf-growth')">i</button></label>
                <input type="range" id="fcf_growth" name="fcf_growth" min="0" max="0.3" step="0.01" value="{{ request.args.get('fcf_growth', 0.10) }}" oninput="updateParam('fcf_growth', this.value, Math.round(this.value * 100) + '%')">
                <span id="fcf_growth-label">{{ "%.0f"|format((request.args.get('fcf_growth', 0.10)|float) * 100) }}%</span>
            </div>
            <div class="param-item">
                <label for="discount_rate">Discount Rate: <button type="button" class="info-btn info-btn-sm" onclick="showInfo('discount-rate')">i</button></label>
                <input type="range" id="discount_rate" name="discount_rate" min="0.05" max="0.20" step="0.01" value="{{ request.args.get('discount_rate', 0.10) }}" oninput="updateParam('discount_rate', this.value, Math.round(this.value * 100) + '%')">
                <span id="discount_rate-label">{{ "%.0f"|format((request.args.get('discount_rate', 0.10)|float) * 100) }}%</span>
            </div>
            <button type="button" class="btn-update" onclick="submitForecastForm()">Update</button>
        </div>

        <div class="model-details">
            <table>
                <tr><td>Base FCF</td><td>${{ results.dcf_model.details.base_fcf }}B</td></tr>
                <tr><td>FCF Growth</td><td>{{ results.dcf_model.details.fcf_growth }}%</td></tr>
                <tr><td>Discount Rate</td><td>{{ results.dcf_model.details.discount_rate }}%</td></tr>
                <tr><td>Terminal Growth</td><td>{{ results.dcf_model.details.terminal_growth }}%</td></tr>
                <tr><td>Intrinsic Value</td><td>${{ results.dcf_model.details.intrinsic_value }}B</td></tr>
            </table>
        </div>
        {% endif %}
    </div>

    <!-- Monte Carlo -->
    <div class="model-card monte-carlo-card">
        <h3>Monte Carlo Simulation <button type="button" class="info-btn" onclick="showInfo('monte-carlo-detail')">i</button></h3>
        {% if results.monte_carlo.get('error') %}
        <p class="model-error">{{ results.monte_carlo.error }}</p>
        {% else %}
        <div class="model-result">
            <div class="target-price">${{ "%.2f"|format(results.monte_carlo.median_target) }}</div>
            <div class="upside {% if results.monte_carlo.median_upside >= 0 %}positive{% else %}negative{% endif %}">
                {{ "%.1f"|format(results.monte_carlo.median_upside) }}% median upside
            </div>
            <div class="simulation-info">
                {{ results.monte_carlo.simulations }} simulations
            </div>
        </div>

        <div class="model-params">
            <h4>Adjust Parameters</h4>
            <div class="param-item">
                <label for="volatility">Volatility: <button type="button" class="info-btn info-btn-sm" onclick="showInfo('volatility')">i</button></label>
                <input type="range" id="volatility" name="volatility" min="0.1" max="0.8" step="0.05" value="{{ request.args.get('volatility', 0.30) }}" oninput="updateParam('volatility', this.value, Math.round(this.value * 100) + '%')">
                <span id="volatility-label">{{ "%.0f"|format((request.args.get('volatility', 0.30)|float) * 100) }}%</span>
            </div>
            <button type="button" class="btn-update" onclick="submitForecastForm()">Update</button>
        </div>

        <div class="percentiles">
            <h4>Price Distribution</h4>
            <div class="percentile-bar">
                <div class="percentile-range" style="left: 10%; width: 80%;">
                    <span class="p10">${{ results.monte_carlo.percentiles.p10 }}</span>
                    <span class="p50">${{ results.monte_carlo.percentiles.p50 }}</span>
                    <span class="p90">${{ results.monte_carlo.percentiles.p90 }}</span>
                </div>
            </div>
            <div class="percentile-labels">
                <span>10th %ile</span>
                <span>Median</span>
                <span>90th %ile</span>
            </div>
        </div>

        <div class="probabilities">
            <h4>Outcome Probabilities</h4>
            <div class="prob-grid">
                <div class="prob-item">
                    <span class="prob-value positive">{{ results.monte_carlo.probabilities.profit }}%</span>
                    <span class="prob-label">Profit</span>
                </div>
                <div class="prob-item">
                    <span class="prob-value positive">{{ results.monte_carlo.probabilities.up_50_percent }}%</span>
                    <span class="prob-label">+50%</span>
                </div>
                <div class="prob-item">
                    <span class="prob-value positive">{{ results.monte_carlo.probabilities.double }}%</span>
                    <span class="prob-label">2x</span>
                </div>
                <div class="prob-item">
                    <span class="prob-value negative">{{ results.monte_carlo.probabilities.down_50_percent }}%</span>
                    <span class="prob-label">-50%</span>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Graham Number Model -->
    <div class="model-card">
        <h3>Graham Number <button type="button" class="info-btn" onclick="showInfo('graham-number-detail')">i</button></h3>
        {% if results.graham_number.error %}
        <p class="model-error">{{ results.graham_number.error }}</p>
        {% else %}
        <div class="model-result">
            <div class="target-price">${{ "%.2f"|format(results.graham_number.intrinsic_value) }}</div>
            <div class="upside {% if results.graham_number.margin_of_safety >= 0 %}positive{% else %}negative{% endif %}">
                {{ "%.1f"|format(results.graham_number.margin_of_safety) }}% margin of safety
            </div>
            <div class="model-recommendation rec-{{ results.graham_number.recommendation|lower|replace(' ', '-') }}">
                {{ results.graham_number.recommendation }}
            </div>
        </div>

        <div class="model-details">
            <table>
                <tr><td>Current Price</td><td>${{ results.graham_number.current_price }}</td></tr>
                <tr><td>Intrinsic Value</td><td>${{ results.graham_number.intrinsic_value }}</td></tr>
                <tr><td>EPS</td><td>${{ results.graham_number.eps }}</td></tr>
                <tr><td>Book Value/Share</td><td>${{ results.graham_number.book_value_per_share }}</td></tr>
            </table>
        </div>
        {% endif %}
    </div>

    <!-- Gordon Growth Model (Dividend Discount) -->
    <div class="model-card">
        <h3>Gordon Growth Model <button type="button" class="info-btn" onclick="showInfo('gordon-growth-detail')">i</button></h3>
        {% if results.gordon_growth.error %}
        <p class="model-error">{{ results.gordon_growth.error }}</p>
        {% else %}
        <div class="model-result">
            <div class="target-price">${{ "%.2f"|format(results.gordon_growth.intrinsic_value) }}</div>
            <div class="upside {% if results.gordon_growth.upside_percent >= 0 %}positive{% else %}negative{% endif %}">
                {{ "%.1f"|format(results.gordon_growth.upside_percent) }}% upside
            </div>
        </div>

        <div class="model-details">
            <table>
                <tr><td>Current Dividend</td><td>${{ results.gordon_growth.current_dividend }}</td></tr>
                <tr><td>Next Year Dividend</td><td>${{ results.gordon_growth.next_year_dividend }}</td></tr>
                <tr><td>Dividend Growth</td><td>{{ results.gordon_growth.dividend_growth_rate }}%</td></tr>
                <tr><td>Required Return</td><td>{{ results.gordon_growth.required_return }}%</td></tr>
                <tr><td>Dividend Yield</td><td>{{ results.gordon_growth.dividend_yield }}%</td></tr>
            </table>
        </div>
        {% endif %}
    </div>

    <!-- PEG-Based Valuation -->
    <div class="model-card">
        <h3>PEG Valuation <button type="button" class="info-btn" onclick="showInfo('peg-valuation-detail')">i</button></h3>
        {% if results.peg_valuation.error %}
        <p class="model-error">{{ results.peg_valuation.error }}</p>
        {% else %}
        <div class="model-result">
            <div class="target-price">${{ "%.2f"|format(results.peg_valuation.fair_price) }}</div>
            <div class="upside {% if results.peg_valuation.upside_percent >= 0 %}positive{% else %}negative{% endif %}">
                {{ "%.1f"|format(results.peg_valuation.upside_percent) }}% upside
            </div>
        </div>

        <div class="model-details">
            <table>
                <tr><td>Fair P/E</td><td>{{ results.peg_valuation.fair_pe }}x</td></tr>
                <tr><td>Current P/E</td><td>{{ results.peg_valuation.current_pe if results.peg_valuation.current_pe else 'N/A' }}x</td></tr>
                <tr><td>Fair PEG</td><td>{{ results.peg_valuation.fair_peg }}x</td></tr>
                <tr><td>Current PEG</td><td>{{ results.peg_valuation.current_peg if results.peg_valuation.current_peg else 'N/A' }}x</td></tr>
                <tr><td>Growth Rate</td><td>{{ results.peg_valuation.growth_rate }}%</td></tr>
            </table>
        </div>
        {% endif %}
    </div>

    <!-- P/S Sector Valuation -->
    <div class="model-card">
        <h3>P/S Sector Valuation <button type="button" class="info-btn" onclick="showInfo('ps-sector-detail')">i</button></h3>
        {% if results.ps_sector.error %}
        <p class="model-error">{{ results.ps_sector.error }}</p>
        {% else %}
        <div class="model-result">
            <div class="target-price">${{ "%.2f"|format(results.ps_sector.fair_price) }}</div>
            <div class="upside {% if results.ps_sector.upside_percent >= 0 %}positive{% else %}negative{% endif %}">
                {{ "%.1f"|format(results.ps_sector.upside_percent) }}% upside
            </div>
        </div>

        <div class="model-details">
            <table>
                <tr><td>Sector Median P/S</td><td>{{ results.ps_sector.sector_median_ps }}x</td></tr>
                <tr><td>Current P/S</td><td>{{ results.ps_sector.current_ps if results.ps_sector.current_ps else 'N/A' }}x</td></tr>
                <tr><td>Revenue/Share</td><td>${{ results.ps_sector.revenue_per_share }}</td></tr>
                <tr><td>Total Revenue</td><td>${{ results.ps_sector.total_revenue }}B</td></tr>
            </table>
        </div>
        {% endif %}
    </div>
</div>

<!-- Summary -->
<div class="forecast-summary">
    <h2>Forecast Summary</h2>
    <p class="subtitle">Average of all models over {{ results.earnings_model.years }} years</p>

    {% set valid_targets = [] %}
    {% if results.earnings_model.target_price > 0 %}
        {% set _ = valid_targets.append(results.earnings_model.target_price) %}
    {% endif %}
    {% if results.revenue_model.target_price > 0 %}
        {% set _ = valid_targets.append(results.revenue_model.target_price) %}
    {% endif %}
    {% if results.dcf_model.target_price > 0 %}
        {% set _ = valid_targets.append(results.dcf_model.target_price) %}
    {% endif %}
    {% if results.monte_carlo.median_target %}
        {% set _ = valid_targets.append(results.monte_carlo.median_target) %}
    {% endif %}
    {% if results.graham_number.intrinsic_value > 0 and not results.graham_number.error %}
        {% set _ = valid_targets.append(results.graham_number.intrinsic_value) %}
    {% endif %}
    {% if results.gordon_growth.intrinsic_value > 0 and not results.gordon_growth.error %}
        {% set _ = valid_targets.append(results.gordon_growth.intrinsic_value) %}
    {% endif %}
    {% if results.peg_valuation.fair_price > 0 and not results.peg_valuation.error %}
        {% set _ = valid_targets.append(results.peg_valuation.fair_price) %}
    {% endif %}
    {% if results.ps_sector.fair_price > 0 and not results.ps_sector.error %}
        {% set _ = valid_targets.append(results.ps_sector.fair_price) %}
    {% endif %}

    {% if valid_targets %}
    {% set avg_target = (valid_targets|sum) / (valid_targets|length) %}
    {% set avg_upside = ((avg_target / results.current_price) - 1) * 100 %}

    <div class="summary-grid">
        <div class="summary-item">
            <span class="label">Current Price</span>
            <span class="value">${{ "%.2f"|format(results.current_price) }}</span>
        </div>
        <div class="summary-item">
            <span class="label">Average Target</span>
            <span class="value">${{ "%.2f"|format(avg_target) }}</span>
        </div>
        <div class="summary-item">
            <span class="label">Average Upside</span>
            <span class="value {% if avg_upside >= 0 %}positive{% else %}negative{% endif %}">{{ "%.1f"|format(avg_upside) }}%</span>
        </div>
    </div>
    {% endif %}
</div>

<!-- Model Consensus -->
{% if results and results.consensus %}
<div class="forecast-summary">
    <h2>Model Consensus</h2>
    <p class="subtitle">Aggregate view from {{ results.consensus.num_models }} valuation models</p>

    <div class="summary-grid">
        <div class="summary-item">
            <span class="label">Consensus Target</span>
            <span class="value">${{ "%.2f"|format(results.consensus.consensus_target) }}</span>
        </div>
        <div class="summary-item">
            <span class="label">Consensus Upside</span>
            <span class="value {% if results.consensus.consensus_upside >= 0 %}positive{% else %}negative{% endif %}">{{ "%.1f"|format(results.consensus.consensus_upside) }}%</span>
        </div>
        <div class="summary-item">
            <span class="label">Agreement Score</span>
            <span class="value score-{{ 'high' if results.consensus.agreement_score >= 70 else 'medium' if results.consensus.agreement_score >= 50 else 'low' }}">
                {{ results.consensus.agreement_score|round(0)|int }}/100
            </span>
        </div>
        <div class="summary-item">
            <span class="label">Price Range</span>
            <span class="value">
                ${{ "%.2f"|format(results.consensus.price_range.min) }} - ${{ "%.2f"|format(results.consensus.price_range.max) }}
            </span>
        </div>
        <div class="summary-item">
            <span class="label">Recommendation</span>
            <span class="recommendation rec-{{ results.consensus.recommendation|lower|replace(' ', '-') }}">
                {{ results.consensus.recommendation }}
            </span>
        </div>
        <div class="summary-item">
            <span class="label">Confidence</span>
            <span class="value">
                {% if results.consensus.agreement_score >= 70 %}
                High agreement
                {% elif results.consensus.agreement_score >= 50 %}
                Moderate agreement
                {% else %}
                Low agreement
                {% endif %}
            </span>
        </div>
    </div>
</div>
{% endif %}

<div class="disclaimer">
    <p><strong>Disclaimer:</strong> These forecasts are for educational purposes only and should not be considered investment advice. Stock prices are inherently unpredictable and actual results may differ significantly from these projections.</p>
</div>

<!-- Info Modal -->
<div class="info-modal-overlay" id="info-modal-overlay" onclick="closeInfo()">
    <div class="info-modal" onclick="event.stopPropagation()">
        <button class="info-modal-close" onclick="closeInfo()">&times;</button>
        <h3 id="info-modal-title"></h3>
        <div id="info-modal-content"></div>
    </div>
</div>

<script>
function updateParam(name, value, labelText) {
    // Update the label
    document.getElementById(name + '-label').textContent = labelText;
    // Update the hidden form field
    document.getElementById('form-' + name).value = value;
}

function formatNumber(value) {
    if (!value || value === 0) return 'N/A';
    const num = parseFloat(value);
    if (num >= 1e12) return '$' + (num / 1e12).toFixed(2) + 'T';
    if (num >= 1e9) return '$' + (num / 1e9).toFixed(2) + 'B';
    if (num >= 1e6) return '$' + (num / 1e6).toFixed(2) + 'M';
    if (num >= 1e3) return '$' + (num / 1e3).toFixed(2) + 'K';
    return '$' + num.toFixed(2);
}

function submitForecastForm() {
    // Get all parameters from the form
    const ticker = document.getElementById('form-ticker').value;
    const params = new URLSearchParams({
        ticker: ticker,
        years: document.getElementById('form-years').value,
        earnings_growth: document.getElementById('form-earnings_growth').value,
        terminal_pe: document.getElementById('form-terminal_pe').value,
        revenue_growth: document.getElementById('form-revenue_growth').value,
        terminal_ps: document.getElementById('form-terminal_ps').value,
        fcf_growth: document.getElementById('form-fcf_growth').value,
        discount_rate: document.getElementById('form-discount_rate').value,
        volatility: document.getElementById('form-volatility').value
    });

    // Show loading state on all update buttons
    const updateButtons = document.querySelectorAll('.btn-update');
    updateButtons.forEach(btn => {
        btn.textContent = 'UPDATING...';
        btn.disabled = true;
        btn.style.opacity = '0.6';
    });

    // Make AJAX request
    fetch('/api/forecast?' + params.toString())
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }

            // Update all forecast values in the DOM
            updateForecastUI(data);

            // Reset button states
            updateButtons.forEach(btn => {
                btn.textContent = 'UPDATE';
                btn.disabled = false;
                btn.style.opacity = '1';
            });
        })
        .catch(error => {
            console.error('Error updating forecast:', error);
            alert('Failed to update forecast. Please try again.');

            // Reset button states
            updateButtons.forEach(btn => {
                btn.textContent = 'UPDATE';
                btn.disabled = false;
                btn.style.opacity = '1';
            });
        });
}

function updateForecastUI(data) {
    // Update Scenarios
    if (data.scenarios && data.scenarios.scenarios) {
        const scenarios = data.scenarios.scenarios;
        ['bear', 'base', 'bull'].forEach(scenario => {
            if (scenarios[scenario]) {
                const s = scenarios[scenario];
                const card = document.querySelector('.scenario-' + scenario);
                if (card) {
                    card.querySelector('.target-price').textContent = '$' + s.target_price.toFixed(2);
                    const upsideEl = card.querySelector('.upside');
                    upsideEl.textContent = s.upside_percent.toFixed(1) + '%';
                    upsideEl.className = 'upside ' + (s.upside_percent >= 0 ? 'positive' : 'negative');
                }
            }
        });
    }

    // Update Earnings Model
    if (data.earnings_model) {
        const em = data.earnings_model;
        updateModelCard('earnings', em);

        // Update details table
        const earningsTable = document.querySelectorAll('.model-card')[0].querySelector('.model-details table');
        if (earningsTable && em.details) {
            earningsTable.innerHTML = `
                <tr><td>Starting EPS</td><td>$${em.details.starting_eps}</td></tr>
                <tr><td>Ending EPS</td><td>$${em.details.ending_eps}</td></tr>
                <tr><td>Growth Rate</td><td>${em.details.initial_growth_rate}%</td></tr>
                <tr><td>Growth Decay</td><td>${em.details.growth_decay}%/yr</td></tr>
                <tr><td>Terminal P/E</td><td>${em.details.terminal_pe}x</td></tr>
            `;
        }
    }

    // Update Revenue Model
    if (data.revenue_model) {
        const rm = data.revenue_model;
        updateModelCard('revenue', rm);

        // Update details table
        const revenueTable = document.querySelectorAll('.model-card')[1].querySelector('.model-details table');
        if (revenueTable && rm.details) {
            revenueTable.innerHTML = `
                <tr><td>Starting Revenue</td><td>${formatNumber(rm.details.starting_revenue)}</td></tr>
                <tr><td>Ending Revenue</td><td>${formatNumber(rm.details.ending_revenue)}</td></tr>
                <tr><td>Revenue CAGR</td><td>${rm.details.revenue_cagr}%</td></tr>
                <tr><td>Terminal P/S</td><td>${rm.details.terminal_ps}x</td></tr>
                <tr><td>Target Margin</td><td>${rm.details.target_margin}%</td></tr>
            `;
        }
    }

    // Update DCF Model
    if (data.dcf_model) {
        const dcf = data.dcf_model;
        updateModelCard('dcf', dcf);

        // Update details table
        const dcfTable = document.querySelectorAll('.model-card')[2].querySelector('.model-details table');
        if (dcfTable && dcf.details) {
            dcfTable.innerHTML = `
                <tr><td>Base FCF</td><td>$${dcf.details.base_fcf}B</td></tr>
                <tr><td>FCF Growth</td><td>${dcf.details.fcf_growth}%</td></tr>
                <tr><td>Discount Rate</td><td>${dcf.details.discount_rate}%</td></tr>
                <tr><td>Terminal Growth</td><td>${dcf.details.terminal_growth}%</td></tr>
                <tr><td>Intrinsic Value</td><td>$${dcf.details.intrinsic_value}B</td></tr>
            `;
        }
    }

    // Update Monte Carlo
    if (data.monte_carlo) {
        const mc = data.monte_carlo;
        const mcCard = document.querySelectorAll('.model-card')[3];
        if (mcCard && mc.median_target) {
            mcCard.querySelector('.target-price').textContent = '$' + mc.median_target.toFixed(2);
            const upsideEl = mcCard.querySelector('.upside');
            upsideEl.textContent = mc.median_upside.toFixed(1) + '% median upside';
            upsideEl.className = 'upside ' + (mc.median_upside >= 0 ? 'positive' : 'negative');

            // Update percentiles
            if (mc.percentiles) {
                mcCard.querySelector('.p10').textContent = '$' + mc.percentiles.p10;
                mcCard.querySelector('.p50').textContent = '$' + mc.percentiles.p50;
                mcCard.querySelector('.p90').textContent = '$' + mc.percentiles.p90;
            }

            // Update probabilities
            if (mc.probabilities) {
                const probItems = mcCard.querySelectorAll('.prob-value');
                if (probItems.length >= 4) {
                    probItems[0].textContent = mc.probabilities.profit + '%';
                    probItems[1].textContent = mc.probabilities.up_50_percent + '%';
                    probItems[2].textContent = mc.probabilities.double + '%';
                    probItems[3].textContent = mc.probabilities.down_50_percent + '%';
                }
            }
        }
    }

    // Update Summary
    const validTargets = [];
    if (data.earnings_model && data.earnings_model.target_price > 0) {
        validTargets.push(data.earnings_model.target_price);
    }
    if (data.revenue_model && data.revenue_model.target_price > 0) {
        validTargets.push(data.revenue_model.target_price);
    }
    if (data.dcf_model && data.dcf_model.target_price > 0) {
        validTargets.push(data.dcf_model.target_price);
    }
    if (data.monte_carlo && data.monte_carlo.median_target) {
        validTargets.push(data.monte_carlo.median_target);
    }

    if (validTargets.length > 0) {
        const avgTarget = validTargets.reduce((a, b) => a + b, 0) / validTargets.length;
        const avgUpside = ((avgTarget / data.current_price) - 1) * 100;

        const summaryItems = document.querySelectorAll('.summary-item .value');
        if (summaryItems.length >= 3) {
            summaryItems[0].textContent = '$' + data.current_price.toFixed(2);
            summaryItems[1].textContent = '$' + avgTarget.toFixed(2);
            summaryItems[2].textContent = avgUpside.toFixed(1) + '%';
            summaryItems[2].className = 'value ' + (avgUpside >= 0 ? 'positive' : 'negative');
        }
    }
}

function updateModelCard(modelType, modelData) {
    // Find the model card by its heading
    let card;
    const allCards = document.querySelectorAll('.model-card');

    if (modelType === 'earnings') card = allCards[0];
    else if (modelType === 'revenue') card = allCards[1];
    else if (modelType === 'dcf') card = allCards[2];

    if (!card || !modelData.target_price) return;

    // Update target price
    card.querySelector('.target-price').textContent = '$' + modelData.target_price.toFixed(2);

    // Update upside
    const upsideEl = card.querySelector('.upside');
    upsideEl.textContent = modelData.upside_percent.toFixed(1) + '% upside';
    upsideEl.className = 'upside ' + (modelData.upside_percent >= 0 ? 'positive' : 'negative');

    // Update annual return
    const returnEl = card.querySelector('.annual-return');
    if (returnEl) {
        returnEl.textContent = modelData.annual_return.toFixed(1) + '% annual return';
    }
}

function selectEarningsSource(value) {
    // Update the earnings growth slider when source is changed
    const slider = document.getElementById('earnings_growth');
    slider.value = value;
    updateParam('earnings_growth', value, Math.round(value * 100) + '%');
}

function selectRevenueSource(value) {
    // Update the revenue growth slider when source is changed
    const slider = document.getElementById('revenue_growth');
    slider.value = value;
    updateParam('revenue_growth', value, Math.round(value * 100) + '%');
}

const infoContent = {
    'params-general': {
        title: 'About Parameters',
        content: `<p>These parameters allow you to adjust the assumptions used in each forecasting model. By changing these values, you can see how sensitive the price forecast is to different assumptions.</p>
        <p><strong>Tip:</strong> Try adjusting parameters to create optimistic and pessimistic scenarios. If the stock looks attractive even with conservative assumptions, it may be a stronger investment candidate.</p>`
    },
    'forecast-years': {
        title: 'Forecast Years',
        content: `<p>The number of years into the future to project the stock price.</p>
        <p><strong>Shorter periods (1-3 years):</strong> More reliable but less potential upside shown.</p>
        <p><strong>Longer periods (5-10 years):</strong> More speculative but shows long-term potential. Compound growth has more time to work.</p>
        <p><strong>Common choice:</strong> 5 years is a standard investment horizon for fundamental analysis.</p>`
    },
    'earnings-model': {
        title: 'Earnings Model Parameters',
        content: `<p>The Earnings Growth Model projects future stock prices based on earnings per share (EPS) growth.</p>
        <p><strong>How it works:</strong> Current EPS grows at your specified rate, then a P/E multiple is applied to get the future price.</p>
        <p>Formula: Future Price = Future EPS √ó Terminal P/E</p>`
    },
    'eps-growth': {
        title: 'EPS Growth Rate',
        content: `<p><strong>What it is:</strong> The annual rate at which earnings per share (EPS) are expected to grow.</p>
        <p><strong>How to think about it:</strong></p>
        <ul>
            <li><strong>0-10%:</strong> Mature, slow-growth companies (utilities, banks)</li>
            <li><strong>10-20%:</strong> Solid growth companies (most S&P 500)</li>
            <li><strong>20-30%:</strong> High-growth companies (tech leaders)</li>
            <li><strong>30%+:</strong> Very aggressive, usually unsustainable long-term</li>
        </ul>
        <p><strong>Tip:</strong> Look at the company's historical EPS growth and analyst estimates. Be conservative - high growth rates are hard to maintain.</p>`
    },
    'terminal-pe': {
        title: 'Terminal P/E Ratio',
        content: `<p><strong>What it is:</strong> The Price-to-Earnings ratio you expect the stock to trade at in the future.</p>
        <p><strong>How to think about it:</strong></p>
        <ul>
            <li><strong>10-15x:</strong> Value stocks, slow growers, cyclicals</li>
            <li><strong>15-20x:</strong> Average market valuation</li>
            <li><strong>20-30x:</strong> Quality growth companies</li>
            <li><strong>30x+:</strong> High-growth tech, premium valuations</li>
        </ul>
        <p><strong>Tip:</strong> Higher P/E ratios are justified by higher growth rates. As growth slows, P/E typically compresses toward market average (~18x).</p>`
    },
    'dcf-model': {
        title: 'DCF Model Parameters',
        content: `<p>Discounted Cash Flow (DCF) values a company based on the present value of its future cash flows.</p>
        <p><strong>How it works:</strong> Projects future free cash flows, then discounts them back to today's value using a required rate of return.</p>
        <p><strong>Why it matters:</strong> DCF is considered one of the most theoretically sound valuation methods because it focuses on actual cash generation, not accounting earnings.</p>`
    },
    'fcf-growth': {
        title: 'Free Cash Flow Growth',
        content: `<p><strong>What it is:</strong> The expected annual growth rate of the company's free cash flow (FCF).</p>
        <p><strong>Free Cash Flow:</strong> Cash from operations minus capital expenditures. It's the cash available to pay dividends, buy back shares, or reinvest.</p>
        <p><strong>Typical ranges:</strong></p>
        <ul>
            <li><strong>3-5%:</strong> Mature, stable companies</li>
            <li><strong>5-10%:</strong> Steady growers</li>
            <li><strong>10-15%:</strong> Growth companies</li>
            <li><strong>15%+:</strong> High growth, usually moderates over time</li>
        </ul>`
    },
    'discount-rate': {
        title: 'Discount Rate',
        content: `<p><strong>What it is:</strong> Your required rate of return, used to calculate what future cash flows are worth today.</p>
        <p><strong>How to think about it:</strong></p>
        <ul>
            <li><strong>8-10%:</strong> Large, stable, blue-chip companies</li>
            <li><strong>10-12%:</strong> Average risk stocks</li>
            <li><strong>12-15%:</strong> Higher risk, smaller companies</li>
            <li><strong>15%+:</strong> High risk, speculative stocks</li>
        </ul>
        <p><strong>Key insight:</strong> Higher discount rate = lower present value = more conservative valuation. Use higher rates for riskier companies.</p>`
    },
    'monte-carlo': {
        title: 'Monte Carlo Parameters',
        content: `<p>Monte Carlo simulation runs thousands of random scenarios to show the range of possible outcomes.</p>
        <p><strong>Why it's useful:</strong> Instead of a single price target, you see probabilities - like "60% chance of profit" or "20% chance of doubling."</p>
        <p><strong>How it works:</strong> Uses random variations based on volatility to simulate many possible price paths, then summarizes the distribution of outcomes.</p>`
    },
    'volatility': {
        title: 'Volatility',
        content: `<p><strong>What it is:</strong> A measure of how much the stock price fluctuates, expressed as an annual percentage.</p>
        <p><strong>Typical ranges:</strong></p>
        <ul>
            <li><strong>15-20%:</strong> Low volatility (utilities, consumer staples)</li>
            <li><strong>20-30%:</strong> Average volatility (most stocks)</li>
            <li><strong>30-50%:</strong> High volatility (tech, growth stocks)</li>
            <li><strong>50%+:</strong> Very high volatility (speculative, small caps)</li>
        </ul>
        <p><strong>Impact:</strong> Higher volatility means wider range of possible outcomes in the Monte Carlo simulation.</p>`
    },
    'scenario-analysis': {
        title: 'Scenario Analysis',
        content: `<p>Shows three possible futures: optimistic (Bull), base case, and pessimistic (Bear).</p>
        <p><strong>Bull Case:</strong> Everything goes right - strong growth, multiple expansion, favorable conditions.</p>
        <p><strong>Base Case:</strong> Reasonable expectations based on current trends and analyst estimates.</p>
        <p><strong>Bear Case:</strong> Things go wrong - slower growth, multiple compression, headwinds.</p>
        <p><strong>How to use it:</strong> Consider the probability of each scenario. If the bear case still offers acceptable returns, the investment has a margin of safety.</p>`
    },
    'earnings-model-detail': {
        title: 'Earnings Growth Model',
        content: `<p><strong>What it does:</strong> Projects future stock price by growing current earnings and applying a P/E multiple.</p>
        <p><strong>Formula:</strong> Future Price = Current EPS √ó (1 + Growth Rate)^Years √ó Terminal P/E</p>
        <p><strong>Best for:</strong> Profitable companies with stable, predictable earnings.</p>
        <p><strong>Limitations:</strong> Doesn't work for unprofitable companies. Assumes P/E ratio is the right valuation metric.</p>
        <p><strong>Key metrics shown:</strong></p>
        <ul>
            <li><strong>Starting/Ending EPS:</strong> Earnings per share now vs. projected</li>
            <li><strong>Growth Decay:</strong> How much growth rate slows each year (high growth doesn't last forever)</li>
        </ul>`
    },
    'revenue-model-detail': {
        title: 'Revenue Growth Model',
        content: `<p><strong>What it does:</strong> Values the company based on revenue growth and a Price-to-Sales (P/S) multiple.</p>
        <p><strong>Best for:</strong> High-growth companies that aren't yet profitable, or where earnings are volatile.</p>
        <p><strong>Key metrics:</strong></p>
        <ul>
            <li><strong>Revenue CAGR:</strong> Compound annual growth rate of revenue</li>
            <li><strong>Terminal P/S:</strong> Price-to-Sales ratio at the end of the forecast period</li>
            <li><strong>Target Margin:</strong> Expected profit margin as the company matures</li>
        </ul>
        <p><strong>Caution:</strong> Revenue without profits isn't sustainable long-term. Look for a path to profitability.</p>`
    },
    'dcf-model-detail': {
        title: 'Discounted Cash Flow (DCF) Model',
        content: `<p><strong>What it does:</strong> Calculates the intrinsic value of a company by discounting future cash flows to present value.</p>
        <p><strong>Why it's important:</strong> DCF is considered the gold standard of valuation because it focuses on actual cash generation.</p>
        <p><strong>Key metrics:</strong></p>
        <ul>
            <li><strong>Base FCF:</strong> Current free cash flow (cash from operations minus CapEx)</li>
            <li><strong>FCF Growth:</strong> Expected annual growth in free cash flow</li>
            <li><strong>Discount Rate:</strong> Your required return (higher = more conservative)</li>
            <li><strong>Terminal Growth:</strong> Long-term perpetual growth rate (usually 2-3%)</li>
            <li><strong>Intrinsic Value:</strong> The calculated fair value of the entire company</li>
        </ul>
        <p><strong>Tip:</strong> If market price is well below intrinsic value, the stock may be undervalued.</p>`
    },
    'monte-carlo-detail': {
        title: 'Monte Carlo Simulation',
        content: `<p><strong>What it does:</strong> Runs thousands of simulated price paths to show the probability distribution of outcomes.</p>
        <p><strong>Why it's useful:</strong> Shows the range of possible outcomes and their likelihood, rather than a single point estimate.</p>
        <p><strong>How to read the results:</strong></p>
        <ul>
            <li><strong>Median Target:</strong> The middle outcome - half of simulations end higher, half lower</li>
            <li><strong>10th Percentile:</strong> Pessimistic outcome (only 10% of simulations were worse)</li>
            <li><strong>90th Percentile:</strong> Optimistic outcome (only 10% of simulations were better)</li>
        </ul>
        <p><strong>Probabilities explained:</strong></p>
        <ul>
            <li><strong>Profit:</strong> Chance of any positive return</li>
            <li><strong>+50%:</strong> Chance of 50%+ gain</li>
            <li><strong>2x:</strong> Chance of doubling your money</li>
            <li><strong>-50%:</strong> Chance of losing half (risk indicator)</li>
        </ul>`
    },
    'graham-number-detail': {
        title: 'Graham Number (Intrinsic Value)',
        content: `<p><strong>What it does:</strong> Benjamin Graham's formula for calculating intrinsic value based on EPS and book value.</p>
        <p><strong>Formula:</strong> Graham Number = ‚àö(22.5 √ó EPS √ó Book Value Per Share)</p>
        <p><strong>Best for:</strong> Value investing approach, profitable companies with positive book value.</p>
        <p><strong>Margin of Safety:</strong> How much cheaper the stock is vs its intrinsic value. >20% is considered a good buy.</p>
        <p><strong>Note:</strong> The 22.5 constant represents a P/E of 15 and P/B of 1.5, Graham's criteria for value stocks.</p>`
    },
    'gordon-growth-detail': {
        title: 'Gordon Growth Model (Dividend Discount)',
        content: `<p><strong>What it does:</strong> Values a stock based on the present value of future dividends.</p>
        <p><strong>Formula:</strong> Fair Value = D1 / (r - g), where D1 = next year dividend, r = required return, g = dividend growth</p>
        <p><strong>Best for:</strong> Dividend-paying stocks with stable dividend growth.</p>
        <p><strong>Assumptions:</strong> Requires dividends to grow at a constant rate less than the required return.</p>
        <p><strong>Note:</strong> Only applicable to stocks that pay dividends. Growth stocks typically don't pay dividends.</p>`
    },
    'peg-valuation-detail': {
        title: 'PEG-Based Valuation',
        content: `<p><strong>What it does:</strong> Calculates fair value assuming a reasonable PEG ratio (typically 1.5).</p>
        <p><strong>Formula:</strong> Fair P/E = Fair PEG √ó Growth Rate (%), Fair Price = Fair P/E √ó EPS</p>
        <p><strong>Best for:</strong> Growth stocks where growth rate justifies the P/E multiple.</p>
        <p><strong>Rule of thumb:</strong> PEG < 1 is undervalued, PEG around 1-1.5 is fair, PEG > 2 is expensive.</p>
        <p><strong>Interpretation:</strong> A PEG of 1.5 means you're paying 1.5x the growth rate for the stock.</p>`
    },
    'ps-sector-detail': {
        title: 'P/S Sector Valuation',
        content: `<p><strong>What it does:</strong> Values stock based on sector median Price-to-Sales ratio.</p>
        <p><strong>Formula:</strong> Fair Price = Sector Median P/S √ó Revenue Per Share</p>
        <p><strong>Best for:</strong> Comparing against sector peers, works for unprofitable companies.</p>
        <p><strong>Assumption:</strong> Company should trade at sector average multiple.</p>
        <p><strong>Note:</strong> P/S multiples vary widely by sector. SaaS companies typically have higher P/S than retail.</p>`
    }
};

function showInfo(key) {
    const info = infoContent[key];
    if (!info) return;

    document.getElementById('info-modal-title').textContent = info.title;
    document.getElementById('info-modal-content').innerHTML = info.content;
    document.getElementById('info-modal-overlay').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeInfo() {
    document.getElementById('info-modal-overlay').classList.remove('active');
    document.body.style.overflow = '';
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeInfo();
});
</script>

<style>
.forecast-selector {
    background: linear-gradient(135deg, #1e2139 0%, #2d3250 100%);
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
    border: 1px solid rgba(0, 255, 136, 0.2);
}

/* Growth Rate Info Section */
.growth-rate-info {
    background: linear-gradient(135deg, #1e2139 0%, #2d3250 100%);
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 30px;
    border: 1px solid rgba(0, 255, 136, 0.2);
}

.growth-rate-info h3 {
    color: #00ff88;
    margin-bottom: 15px;
    font-size: 1.2rem;
}

.growth-info-banner {
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.growth-info-banner.historical {
    background: rgba(0, 255, 136, 0.15);
    border: 1px solid rgba(0, 255, 136, 0.4);
}

.growth-info-banner.fallback {
    background: rgba(255, 215, 0, 0.15);
    border: 1px solid rgba(255, 215, 0, 0.4);
}

.badge-historical {
    background: #00ff88;
    color: #0a0e27;
    padding: 6px 14px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
}

.badge-fallback {
    background: #ffd700;
    color: #0a0e27;
    padding: 6px 14px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
}

.growth-info-banner p {
    margin: 0;
    color: #e0e6ed;
    font-size: 0.95rem;
}

.growth-metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.growth-metric-card {
    background: rgba(10, 14, 39, 0.5);
    padding: 20px;
    border-radius: 10px;
    border: 1px solid rgba(0, 255, 136, 0.1);
}

.growth-metric-card h4 {
    color: #a8b2d1;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 12px;
}

.growth-metric-card .metric-value {
    font-size: 2rem;
    font-weight: 700;
    color: #ffd700;
    font-family: 'Courier New', monospace;
    margin-bottom: 10px;
}

.growth-metric-card .metric-value.consistency-high {
    color: #00ff88;
}

.growth-metric-card .metric-value.consistency-medium {
    color: #ffd700;
}

.growth-metric-card .metric-value.consistency-low {
    color: #ff3366;
}

.growth-metric-card .metric-source {
    margin-bottom: 8px;
}

.growth-metric-card .source-label {
    color: #6b7a99;
    font-size: 0.8rem;
    display: inline-block;
    margin-right: 6px;
}

.growth-metric-card .source-value {
    font-weight: 600;
    font-size: 0.85rem;
}

.growth-metric-card .source-value.historical {
    color: #00ff88;
}

.growth-metric-card .source-value.fallback {
    color: #ffd700;
}

.growth-metric-card .metric-detail {
    color: #a8b2d1;
    font-size: 0.8rem;
    margin-top: 5px;
}

/* Source Selector Dropdown */
.source-selector {
    width: 100%;
    padding: 10px 12px;
    background: rgba(10, 14, 39, 0.6);
    color: #e0e6ed;
    border: 2px solid rgba(0, 255, 136, 0.3);
    border-radius: 6px;
    font-size: 0.9rem;
    font-family: 'Courier New', monospace;
    cursor: pointer;
    transition: all 0.3s;
}

.source-selector:hover {
    border-color: #00ff88;
    background: rgba(10, 14, 39, 0.8);
}

.source-selector:focus {
    outline: none;
    border-color: #00ff88;
    box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
}

.source-selector option {
    background: #1e2139;
    color: #e0e6ed;
    padding: 10px;
}

/* Valuation Multiples Section */
.valuation-multiples-section {
    background: linear-gradient(135deg, #1e2139 0%, #2d3250 100%);
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 30px;
    border: 1px solid rgba(255, 215, 0, 0.2);
}

.valuation-multiples-section h3 {
    color: #ffd700;
    margin-bottom: 10px;
    font-size: 1.2rem;
}

.section-description {
    color: #a8b2d1;
    font-size: 0.9rem;
    margin-bottom: 20px;
}

.multiples-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.multiple-card {
    background: rgba(10, 14, 39, 0.5);
    padding: 20px;
    border-radius: 10px;
    border: 1px solid rgba(255, 215, 0, 0.1);
}

.multiple-card h4 {
    color: #ffd700;
    font-size: 0.95rem;
    margin-bottom: 15px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.multiple-main-value {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(255, 215, 0, 0.1);
}

.multiple-main-value .label {
    color: #a8b2d1;
    font-size: 0.85rem;
}

.multiple-main-value .value {
    font-size: 1.8rem;
    font-weight: 700;
    font-family: 'Courier New', monospace;
}

.multiple-main-value .value.pe-low,
.multiple-main-value .value.ps-low,
.multiple-main-value .value.pb-low {
    color: #00ff88;
}

.multiple-main-value .value.pe-medium,
.multiple-main-value .value.ps-medium,
.multiple-main-value .value.pb-medium {
    color: #ffd700;
}

.multiple-main-value .value.pe-high,
.multiple-main-value .value.ps-high,
.multiple-main-value .value.pb-high {
    color: #ff9500;
}

.multiple-main-value .value.pe-very-high,
.multiple-main-value .value.ps-very-high {
    color: #ff3366;
}

.multiple-secondary {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    font-size: 0.85rem;
}

.multiple-secondary .label {
    color: #6b7a99;
}

.multiple-secondary .value {
    color: #e0e6ed;
    font-weight: 600;
}

.multiple-guide {
    background: rgba(0, 255, 136, 0.05);
    padding: 12px;
    border-radius: 6px;
    margin-top: 12px;
    margin-bottom: 12px;
}

.multiple-guide strong {
    color: #00ff88;
    font-size: 0.8rem;
    display: block;
    margin-bottom: 8px;
}

.multiple-guide ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.multiple-guide li {
    color: #a8b2d1;
    font-size: 0.75rem;
    padding: 3px 0;
    padding-left: 12px;
    position: relative;
}

.multiple-guide li:before {
    content: "‚ñ∏";
    position: absolute;
    left: 0;
    color: #00ff88;
}

.multiple-recommendation {
    margin-top: 10px;
}

.rec-badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    text-align: center;
    width: 100%;
}

.rec-badge.rec-conservative {
    background: rgba(0, 255, 136, 0.15);
    color: #00ff88;
    border: 1px solid rgba(0, 255, 136, 0.3);
}

.rec-badge.rec-moderate {
    background: rgba(255, 215, 0, 0.15);
    color: #ffd700;
    border: 1px solid rgba(255, 215, 0, 0.3);
}

.rec-badge.rec-growth {
    background: rgba(255, 149, 0, 0.15);
    color: #ff9500;
    border: 1px solid rgba(255, 149, 0, 0.3);
}

.rec-badge.rec-aggressive {
    background: rgba(255, 51, 102, 0.15);
    color: #ff3366;
    border: 1px solid rgba(255, 51, 102, 0.3);
}

.classification-card {
    background: rgba(10, 14, 39, 0.7);
    border: 2px solid rgba(255, 215, 0, 0.2);
}

.classification-result {
    margin-bottom: 15px;
}

.classification-badge {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
}

.classification-badge.premium {
    background: rgba(255, 51, 102, 0.15);
    border: 2px solid #ff3366;
}

.classification-badge.growth {
    background: rgba(255, 149, 0, 0.15);
    border: 2px solid #ff9500;
}

.classification-badge.value {
    background: rgba(0, 255, 136, 0.15);
    border: 2px solid #00ff88;
}

.classification-badge.fair {
    background: rgba(255, 215, 0, 0.15);
    border: 2px solid #ffd700;
}

.classification-badge .icon {
    font-size: 2rem;
}

.classification-badge .text {
    font-size: 1.1rem;
    font-weight: 700;
    color: #e0e6ed;
}

.classification-desc {
    color: #a8b2d1;
    font-size: 0.85rem;
    margin: 0;
    line-height: 1.5;
}

.sector-context {
    display: flex;
    justify-content: space-between;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid rgba(255, 215, 0, 0.1);
}

.sector-context .label {
    color: #6b7a99;
    font-size: 0.85rem;
}

.sector-context .value {
    color: #ffd700;
    font-weight: 600;
    font-size: 0.9rem;
}

.multiples-tips {
    background: rgba(0, 255, 136, 0.05);
    padding: 20px;
    border-radius: 8px;
    border: 1px solid rgba(0, 255, 136, 0.2);
}

.multiples-tips h4 {
    color: #00ff88;
    font-size: 0.95rem;
    margin-bottom: 15px;
}

.tips-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.tip-item {
    color: #a8b2d1;
    font-size: 0.85rem;
    line-height: 1.5;
}

.tip-item strong {
    color: #00ff88;
    display: block;
    margin-bottom: 5px;
}

/* Search Input */
.search-container {
    position: relative;
    width: 100%;
    max-width: 400px;
}

.forecast-selector input[type="text"] {
    width: 100%;
    padding: 12px;
    font-size: 1rem;
    background: rgba(10, 14, 39, 0.6);
    color: #e0e6ed;
    border: 2px solid rgba(0, 255, 136, 0.3);
    border-radius: 6px;
    transition: all 0.3s;
}

.forecast-selector input[type="text"]:focus {
    outline: none;
    border-color: #00ff88;
    box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
}

.forecast-selector input[type="text"]::placeholder {
    color: #a8b2d1;
}

.search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #1e2139 0%, #2d3250 100%);
    border: 2px solid rgba(0, 255, 136, 0.3);
    border-top: none;
    border-radius: 0 0 6px 6px;
    max-height: 300px;
    overflow-y: auto;
    display: none;
    z-index: 100;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.search-result-item {
    padding: 12px;
    cursor: pointer;
    color: #e0e6ed;
    font-family: 'Courier New', monospace;
    font-weight: 600;
    border-bottom: 1px solid rgba(0, 255, 136, 0.1);
    transition: all 0.3s;
}

.search-result-item:last-child {
    border-bottom: none;
}

.search-result-item:hover,
.search-result-item.active {
    background: rgba(0, 255, 136, 0.1);
    color: #00ff88;
}

.forecast-header {
    background: linear-gradient(135deg, #1e2139 0%, #2d3250 100%);
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
    border: 1px solid rgba(0, 255, 136, 0.2);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.forecast-header h2 {
    color: #00ff88;
    margin: 0;
}

.current-price {
    text-align: right;
}

.current-price .label {
    display: block;
    color: #a8b2d1;
    font-size: 0.9rem;
    text-transform: uppercase;
}

.current-price .value {
    font-size: 2.5rem;
    font-weight: 700;
    color: #ffd700;
    font-family: 'Courier New', monospace;
}

/* Generic Parameter Item Styles */
.param-item {
    margin-bottom: 15px;
}

.param-item label {
    display: block;
    color: #a8b2d1;
    font-size: 0.85rem;
    margin-bottom: 8px;
}

.param-item input[type="range"] {
    width: 100%;
    height: 6px;
    background: rgba(0, 255, 136, 0.2);
    border-radius: 3px;
    outline: none;
    -webkit-appearance: none;
}

.param-item input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    background: #00ff88;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
}

.param-item span {
    display: inline-block;
    margin-top: 5px;
    color: #ffd700;
    font-weight: 600;
    font-family: 'Courier New', monospace;
}

/* Scenarios */
.scenarios-section {
    background: linear-gradient(135deg, #1e2139 0%, #2d3250 100%);
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
    border: 1px solid rgba(0, 255, 136, 0.2);
}

.scenarios-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    gap: 30px;
}

.scenarios-header .param-item {
    min-width: 200px;
    margin: 0;
}

.scenarios-section h2 {
    color: #00ff88;
    margin-bottom: 10px;
}

.scenarios-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
}

.scenario-card {
    padding: 25px;
    border-radius: 10px;
    text-align: center;
    border: 2px solid;
}

.scenario-bear {
    background: rgba(255, 51, 102, 0.1);
    border-color: #ff3366;
}

.scenario-base {
    background: rgba(255, 215, 0, 0.1);
    border-color: #ffd700;
}

.scenario-bull {
    background: rgba(0, 255, 136, 0.1);
    border-color: #00ff88;
}

.scenario-card h3 {
    margin-bottom: 15px;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.scenario-bear h3 { color: #ff3366; }
.scenario-base h3 { color: #ffd700; }
.scenario-bull h3 { color: #00ff88; }

.scenario-card .target-price {
    font-size: 2rem;
    font-weight: 700;
    color: #e0e6ed;
    font-family: 'Courier New', monospace;
}

.scenario-card .upside {
    font-size: 1.2rem;
    font-weight: 600;
    margin: 10px 0;
}

.scenario-details {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.scenario-details p {
    color: #a8b2d1;
    font-size: 0.9rem;
    margin: 5px 0;
}

/* Models Grid */
.models-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 25px;
    margin-bottom: 30px;
}

.model-card {
    background: linear-gradient(135deg, #1e2139 0%, #2d3250 100%);
    padding: 25px;
    border-radius: 12px;
    border: 1px solid rgba(0, 255, 136, 0.2);
}

.model-card h3 {
    color: #00ff88;
    margin-bottom: 20px;
    font-size: 1.1rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    border-bottom: 2px solid #00ff88;
    padding-bottom: 10px;
}

.model-result {
    text-align: center;
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(0, 255, 136, 0.1);
}

.model-result .target-price {
    font-size: 2.5rem;
    font-weight: 700;
    color: #ffd700;
    font-family: 'Courier New', monospace;
}

.model-result .upside {
    font-size: 1.2rem;
    font-weight: 600;
    margin: 10px 0;
}

.model-result .annual-return,
.model-result .simulation-info {
    color: #a8b2d1;
    font-size: 0.9rem;
}

.positive { color: #00ff88; }
.negative { color: #ff3366; }

.model-details table {
    width: 100%;
    font-size: 0.9rem;
}

.model-details td {
    padding: 8px 0;
    border-bottom: 1px solid rgba(0, 255, 136, 0.1);
}

.model-details td:first-child {
    color: #a8b2d1;
}

.model-details td:last-child {
    text-align: right;
    color: #e0e6ed;
    font-weight: 600;
    font-family: 'Courier New', monospace;
}

.model-error {
    color: #ff3366;
    text-align: center;
    padding: 20px;
}

/* Model Parameters */
.model-params {
    background: rgba(10, 14, 39, 0.4);
    padding: 20px;
    border-radius: 8px;
    border: 1px solid rgba(0, 255, 136, 0.1);
    margin-bottom: 20px;
}

.model-params h4 {
    color: #00ff88;
    margin-bottom: 15px;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.model-params .param-item:last-of-type {
    margin-bottom: 20px;
}

.btn-update {
    width: 100%;
    padding: 10px 20px;
    background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
    color: #0a0e27;
    border: none;
    border-radius: 6px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.9rem;
}

.btn-update:hover {
    background: linear-gradient(135deg, #00cc6a 0%, #00ff88 100%);
    box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
    transform: translateY(-2px);
}

/* Monte Carlo Specific */
.percentiles {
    margin: 20px 0;
}

.percentiles h4,
.probabilities h4 {
    color: #a8b2d1;
    font-size: 0.85rem;
    text-transform: uppercase;
    margin-bottom: 15px;
}

.percentile-bar {
    background: rgba(0, 255, 136, 0.1);
    height: 40px;
    border-radius: 20px;
    position: relative;
    margin: 10px 0;
}

.percentile-range {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    justify-content: space-between;
    width: 100%;
    padding: 0 20px;
}

.percentile-range span {
    color: #ffd700;
    font-weight: 700;
    font-family: 'Courier New', monospace;
}

.percentile-labels {
    display: flex;
    justify-content: space-between;
    color: #a8b2d1;
    font-size: 0.8rem;
    padding: 0 10px;
}

.prob-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    text-align: center;
}

.prob-item {
    background: rgba(10, 14, 39, 0.4);
    padding: 15px;
    border-radius: 8px;
}

.prob-value {
    display: block;
    font-size: 1.5rem;
    font-weight: 700;
    font-family: 'Courier New', monospace;
}

.prob-label {
    display: block;
    color: #a8b2d1;
    font-size: 0.8rem;
    margin-top: 5px;
}

/* Summary */
.forecast-summary {
    background: linear-gradient(135deg, #1e2139 0%, #2d3250 100%);
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
    border: 2px solid #00ff88;
    box-shadow: 0 0 30px rgba(0, 255, 136, 0.2);
}

.forecast-summary h2 {
    color: #00ff88;
    margin-bottom: 10px;
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 30px;
    margin-top: 25px;
}

.summary-item {
    text-align: center;
}

.summary-item .label {
    display: block;
    color: #a8b2d1;
    font-size: 0.9rem;
    text-transform: uppercase;
    margin-bottom: 10px;
}

.summary-item .value {
    font-size: 2rem;
    font-weight: 700;
    font-family: 'Courier New', monospace;
}

.disclaimer {
    background: rgba(255, 215, 0, 0.1);
    padding: 20px;
    border-radius: 8px;
    border-left: 4px solid #ffd700;
    margin-top: 30px;
}

.disclaimer p {
    color: #a8b2d1;
    font-size: 0.9rem;
    margin: 0;
}

@media (max-width: 768px) {
    .scenarios-grid {
        grid-template-columns: 1fr;
    }

    .scenarios-header {
        flex-direction: column;
        align-items: stretch;
        gap: 20px;
    }

    .scenarios-header .param-item {
        width: 100%;
    }

    .summary-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }

    .prob-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .forecast-header {
        flex-direction: column;
        text-align: center;
        gap: 20px;
    }
}

/* Info Button */
.info-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: rgba(0, 255, 136, 0.2);
    border: 1px solid rgba(0, 255, 136, 0.5);
    color: #00ff88;
    font-size: 0.85rem;
    font-weight: 700;
    font-style: italic;
    font-family: Georgia, serif;
    cursor: pointer;
    transition: all 0.3s;
    vertical-align: middle;
    margin-left: 8px;
    padding: 0;
    line-height: 1;
}

.info-btn:hover {
    background: rgba(0, 255, 136, 0.4);
    box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
    transform: scale(1.1);
}

.info-btn-sm {
    width: 16px;
    height: 16px;
    font-size: 0.7rem;
    margin-left: 5px;
}

/* Info Modal */
.info-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(10, 14, 39, 0.9);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.info-modal-overlay.active {
    display: flex;
}

.info-modal {
    background: linear-gradient(135deg, #1e2139 0%, #2d3250 100%);
    border: 2px solid #00ff88;
    border-radius: 12px;
    max-width: 600px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    padding: 30px;
    position: relative;
    box-shadow: 0 0 40px rgba(0, 255, 136, 0.3);
    animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.info-modal-close {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: rgba(255, 51, 102, 0.2);
    border: 1px solid rgba(255, 51, 102, 0.5);
    color: #ff3366;
    font-size: 1.5rem;
    line-height: 1;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.info-modal-close:hover {
    background: rgba(255, 51, 102, 0.4);
    box-shadow: 0 0 10px rgba(255, 51, 102, 0.5);
}

.info-modal h3 {
    color: #00ff88;
    font-size: 1.4rem;
    margin-bottom: 20px;
    padding-right: 40px;
    border-bottom: 2px solid #00ff88;
    padding-bottom: 15px;
}

.info-modal p {
    color: #e0e6ed;
    line-height: 1.7;
    margin-bottom: 15px;
}

.info-modal ul {
    color: #e0e6ed;
    margin: 15px 0;
    padding-left: 20px;
}

.info-modal li {
    margin-bottom: 10px;
    line-height: 1.6;
}

.info-modal strong {
    color: #ffd700;
}

/* Score colors for consensus agreement */
.score-high {
    color: #4CAF50;
}

.score-medium {
    color: #FF9800;
}

.score-low {
    color: #f44336;
}

/* Recommendation badges */
.recommendation {
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.9em;
}

.rec-strong-buy {
    background: #4CAF50;
    color: white;
}

.rec-buy {
    background: #8BC34A;
    color: white;
}

.rec-speculative-buy {
    background: #FFC107;
    color: #333;
}

.rec-hold {
    background: #FF9800;
    color: white;
}

.rec-sell {
    background: #f44336;
    color: white;
}

.rec-fair-value {
    background: #2196F3;
    color: white;
}

.rec-overvalued {
    background: #FF9800;
    color: white;
}

.rec-significantly-overvalued {
    background: #f44336;
    color: white;
}

.rec-n-a {
    background: #9E9E9E;
    color: white;
}

.model-recommendation {
    margin-top: 10px;
    padding: 8px 12px;
    border-radius: 6px;
    text-align: center;
    font-weight: 600;
}
</style>

{% else %}
<div class="info-section">
    <h2>How to Use the Forecaster</h2>
    <p>Select a stock from the dropdown above to see price forecasts using multiple valuation methods:</p>
    <ul>
        <li><strong>Earnings Growth Model:</strong> Projects future EPS and applies a terminal P/E multiple</li>
        <li><strong>Revenue Growth Model:</strong> Projects revenue and applies a P/S multiple (good for growth stocks)</li>
        <li><strong>DCF Model:</strong> Discounted Cash Flow analysis with customizable parameters</li>
        <li><strong>Monte Carlo Simulation:</strong> Probabilistic forecasting with outcome distributions</li>
        <li><strong>Scenario Analysis:</strong> Bull, Base, and Bear case projections</li>
    </ul>

    <div class="info-box">
        <h3>Adjust Parameters</h3>
        <p>After selecting a stock, you can adjust various parameters like growth rates, multiples, and discount rates to see how they affect the forecast. This helps you understand the sensitivity of the valuation to different assumptions.</p>
    </div>
</div>
{% endif %}

{% endblock %}
