{% extends "base.html" %}

{% block title %}Cryptocurrency - Macro Signals{% endblock %}

{% block content %}
<div class="macro-dashboard">
    <div class="page-header">
        <h1>Cryptocurrency Analysis</h1>
        <p class="subtitle">Bitcoin performance vs fiat currencies - Digital gold perspective</p>
    </div>

    <!-- Section 1: BTC Market Overview -->
    <div class="macro-section">
        <h2>Bitcoin Market Overview</h2>

        <div class="metrics-grid">
            <div class="metric-card neutral">
                <div class="metric-label">BTC Price</div>
                <div class="metric-value">${{ '{:,.0f}'.format(btc_market_data.current_price) if btc_market_data.current_price else 'N/A' }}</div>
            </div>
            <div class="metric-card neutral">
                <div class="metric-label">Market Cap</div>
                <div class="metric-value">${{ '%.2f'|format(btc_market_data.market_cap_trillions) if btc_market_data.market_cap_trillions else 'N/A' }}T</div>
            </div>
            <div class="metric-card neutral">
                <div class="metric-label">52W High</div>
                <div class="metric-value">${{ '{:,.0f}'.format(btc_market_data.high_52w) if btc_market_data.high_52w else 'N/A' }}</div>
            </div>
            <div class="metric-card neutral">
                <div class="metric-label">52W Low</div>
                <div class="metric-value">${{ '{:,.0f}'.format(btc_market_data.low_52w) if btc_market_data.low_52w else 'N/A' }}</div>
            </div>
        </div>

        <div class="chart-container" style="height: 400px;">
            <canvas id="btcPriceChart"></canvas>
        </div>
    </div>

    <!-- Section 2: Market Cap Comparison -->
    <div class="macro-section">
        <h2>
            Market Cap Comparison: BTC vs Gold vs Silver
            <span class="tooltip">i
                <span class="tooltiptext">
                    <strong>Store of Value Assets</strong><br><br>
                    Comparing total market capitalization:<br>
                    - Gold: ~210,000 tonnes above ground<br>
                    - Silver: ~50,000 tonnes (investment grade)<br>
                    - Bitcoin: 21M max supply<br><br>
                    Shows Bitcoin's size relative to traditional stores of value.
                </span>
            </span>
        </h2>

        {% if asset_market_caps %}
        <div class="market-cap-comparison">
            <div class="market-cap-bar-container">
                {% for asset_key in ['gold', 'btc', 'silver'] %}
                {% set asset = asset_market_caps[asset_key] %}
                {% if asset and asset.percentage %}
                <div class="market-cap-bar" style="width: {{ asset.percentage }}%; background-color: {{ asset.color }};">
                    <span class="bar-label">{{ asset.name }}: {{ asset.percentage }}%</span>
                </div>
                {% endif %}
                {% endfor %}
            </div>

            <div class="metrics-grid" style="margin-top: 1.5rem;">
                <div class="metric-card" style="border-left: 3px solid #ffd700;">
                    <div class="metric-label">Gold Market Cap</div>
                    <div class="metric-value">${{ asset_market_caps.gold.market_cap_trillions if asset_market_caps.gold.market_cap_trillions else 'N/A' }}T</div>
                    <div class="metric-sublabel">${{ asset_market_caps.gold.price_per_oz if asset_market_caps.gold.price_per_oz else 'N/A' }}/oz</div>
                </div>
                <div class="metric-card" style="border-left: 3px solid #f7931a;">
                    <div class="metric-label">Bitcoin Market Cap</div>
                    <div class="metric-value">${{ asset_market_caps.btc.market_cap_trillions if asset_market_caps.btc.market_cap_trillions else 'N/A' }}T</div>
                    <div class="metric-sublabel">{{ asset_market_caps.btc.percentage if asset_market_caps.btc.percentage else 'N/A' }}% of Gold+BTC+Silver</div>
                </div>
                <div class="metric-card" style="border-left: 3px solid #c0c0c0;">
                    <div class="metric-label">Silver Market Cap</div>
                    <div class="metric-value">${{ asset_market_caps.silver.market_cap_trillions if asset_market_caps.silver.market_cap_trillions else 'N/A' }}T</div>
                    <div class="metric-sublabel">${{ asset_market_caps.silver.price_per_oz if asset_market_caps.silver.price_per_oz else 'N/A' }}/oz</div>
                </div>
            </div>

            <div class="explanation-box" style="margin-top: 1rem;">
                <p><strong>Total combined market cap:</strong> ${{ asset_market_caps.total_trillions if asset_market_caps.total_trillions else 'N/A' }}T. Bitcoin bulls argue BTC could eventually capture a larger share of this "store of value" market.</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Section 3: Normalized Asset Comparison -->
    <div class="macro-section">
        <h2>
            Relative Performance: BTC vs Gold vs Silver vs S&P 500
            <span class="tooltip">i
                <span class="tooltiptext">
                    <strong>Normalized to 100 at start</strong><br><br>
                    All assets start at 100, showing relative % gains/losses over time.<br><br>
                    Example: Value of 200 = +100% gain from start<br>
                    Value of 50 = -50% loss from start<br><br>
                    Allows direct comparison of performance regardless of price level.
                </span>
            </span>
        </h2>

        {% if asset_comparison and asset_comparison.datasets %}
        <div class="timeline-buttons">
            <button class="timeline-btn" data-period="1m">1M</button>
            <button class="timeline-btn" data-period="3m">3M</button>
            <button class="timeline-btn" data-period="6m">6M</button>
            <button class="timeline-btn" data-period="1y">1Y</button>
            <button class="timeline-btn" data-period="3y">3Y</button>
            <button class="timeline-btn active" data-period="5y">5Y</button>
        </div>

        <div class="chart-container" style="height: 450px;">
            <canvas id="assetComparisonChart"></canvas>
        </div>

        <div class="explanation-box" style="margin-top: 1rem;">
            <p><strong>How to read:</strong> All assets normalized to 100 at the start of the period. A value above 100 means gains, below 100 means losses. This allows direct comparison of performance across very different asset classes.</p>
        </div>
        {% endif %}
    </div>

    <!-- Section 4: BTC Returns -->
    <div class="macro-section">
        <h2>Bitcoin Performance (USD)</h2>
        <p class="table-description">
            Bitcoin price returns across different timeframes
        </p>

        <table class="macro-table">
            <thead>
                <tr>
                    <th>Asset</th>
                    <th>1 Day</th>
                    <th>1 Week</th>
                    <th>1 Month</th>
                    <th>3 Months</th>
                    <th>1 Year</th>
                    <th>3 Years</th>
                    <th>5 Years</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>{{ btc_returns.name if btc_returns else 'BTC/USD' }}</strong></td>
                    {% for period in ['1d', '1w', '1m', '3m', '1y', '3y', '5y'] %}
                    <td class="{{ 'positive' if btc_returns[period] and btc_returns[period] > 0 else 'negative' if btc_returns[period] and btc_returns[period] < 0 else '' }}">
                        {% if btc_returns and btc_returns[period] is not none %}
                            {% if btc_returns[period] >= 0 %}+{% endif %}{{ "%.2f"|format(btc_returns[period]) }}%
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Section 5: Currencies vs Bitcoin -->
    <div class="macro-section">
        <h2>
            Currency Performance vs Bitcoin
            <span class="tooltip">i
                <span class="tooltiptext">
                    <strong>How currencies have performed vs BTC</strong><br><br>
                    Negative % = Currency lost purchasing power vs BTC<br>
                    (BTC price increased in that currency)<br><br>
                    Positive % = Currency gained purchasing power vs BTC<br>
                    (BTC price decreased in that currency)<br><br>
                    Similar to Ray Dalio's gold analysis but for digital assets.
                </span>
            </span>
        </h2>
        <p class="table-description">
            Positive % = Currency gained vs BTC | Negative % = Currency lost vs BTC
        </p>

        <table class="macro-table">
            <thead>
                <tr>
                    <th>Currency</th>
                    <th>1 Day</th>
                    <th>1 Week</th>
                    <th>1 Month</th>
                    <th>3 Months</th>
                    <th>1 Year</th>
                    <th>3 Years</th>
                    <th>5 Years</th>
                </tr>
            </thead>
            <tbody>
                {% for currency in btc_vs_currencies %}
                <tr>
                    <td><strong>{{ currency.name }}</strong></td>
                    {% for period in ['1d', '1w', '1m', '3m', '1y', '3y', '5y'] %}
                    <td class="{{ 'positive' if currency[period] and currency[period] > 0 else 'negative' if currency[period] and currency[period] < 0 else '' }}">
                        {% if currency[period] is not none %}
                            {% if currency[period] >= 0 %}+{% endif %}{{ "%.2f"|format(currency[period]) }}%
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="explanation-box">
            <p><strong>Digital Gold Thesis:</strong> Some investors view Bitcoin as "digital gold" - a store of value that may appreciate against fiat currencies over time due to its fixed supply. Compare these returns to the <a href="{{ url_for('macro.macro_currencies') }}">Gold vs Currencies table</a> to see how both assets perform as inflation hedges and stores of value.</p>
        </div>
    </div>

    <!-- Section 6: Bitcoin Halving Cycle -->
    <div class="macro-section">
        <h2>
            Bitcoin Halving Cycle
            <span class="tooltip">i
                <span class="tooltiptext">
                    <strong>What is the Halving?</strong><br><br>
                    Every ~4 years (210,000 blocks), Bitcoin's block reward is cut in half.<br><br>
                    This reduces new BTC supply, increasing scarcity.<br><br>
                    Historically, the 12-18 months after halvings have been the strongest periods for BTC price.
                </span>
            </span>
        </h2>

        {% if halving_cycle %}
        <div class="halving-container">
            <div class="cycle-progress-container">
                <div class="cycle-progress-bar">
                    <div class="cycle-progress-fill" style="width: {{ halving_cycle.cycle_progress }}%; background-color: {{ halving_cycle.phase_color }};"></div>
                </div>
                <div class="cycle-labels">
                    <span>Halving {{ halving_cycle.last_halving.number }}</span>
                    <span>{{ halving_cycle.phase }}</span>
                    <span>Next Halving (~{{ halving_cycle.next_halving_estimate[:4] }})</span>
                </div>
            </div>

            <div class="metrics-grid" style="margin-top: 1.5rem;">
                <div class="metric-card" style="border-left: 3px solid {{ halving_cycle.phase_color }};">
                    <div class="metric-label">Days Since Halving</div>
                    <div class="metric-value">{{ halving_cycle.days_since_halving }}</div>
                    <div class="metric-sublabel">{{ halving_cycle.last_halving.date }}</div>
                </div>
                <div class="metric-card" style="border-left: 3px solid #2196f3;">
                    <div class="metric-label">Days Until Next</div>
                    <div class="metric-value">~{{ halving_cycle.days_until_next }}</div>
                    <div class="metric-sublabel">Estimate: {{ halving_cycle.next_halving_estimate }}</div>
                </div>
                <div class="metric-card" style="border-left: 3px solid #f7931a;">
                    <div class="metric-label">Current Block Reward</div>
                    <div class="metric-value">{{ halving_cycle.current_reward }} BTC</div>
                    <div class="metric-sublabel">Per block (~10 min)</div>
                </div>
                <div class="metric-card" style="border-left: 3px solid {{ halving_cycle.phase_color }};">
                    <div class="metric-label">Cycle Phase</div>
                    <div class="metric-value" style="font-size: 1.2rem; color: {{ halving_cycle.phase_color }};">{{ halving_cycle.phase }}</div>
                    <div class="metric-sublabel">{{ halving_cycle.cycle_progress }}% through cycle</div>
                </div>
            </div>

            <div class="explanation-box" style="margin-top: 1rem;">
                <p>{{ halving_cycle.interpretation }}</p>
            </div>

            <!-- Historical Cycle Performance -->
            <h3 style="margin-top: 1.5rem; color: #ccc;">Historical Cycle Performance</h3>
            <table class="macro-table">
                <thead>
                    <tr>
                        <th>Cycle</th>
                        <th>Halving Price</th>
                        <th>Cycle High</th>
                        <th>Return</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cycle in halving_cycle.cycle_history %}
                    <tr>
                        <td>{{ cycle.cycle }}</td>
                        <td>${{ cycle.halving_price | int if cycle.halving_price is number else cycle.halving_price }}</td>
                        <td>${{ cycle.cycle_high | int if cycle.cycle_high is number else cycle.cycle_high }}</td>
                        <td class="positive">{{ cycle.return }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>

    <!-- Section 7: BTC vs M2 Money Supply -->
    <div class="macro-section">
        <h2>
            Bitcoin vs M2 Money Supply
            <span class="tooltip">i
                <span class="tooltiptext">
                    <strong>Liquidity Thesis</strong><br><br>
                    BTC price often follows global liquidity (M2 money supply).<br><br>
                    When central banks print money (M2 rises), risk assets including BTC tend to benefit.<br><br>
                    This chart shows the relationship between money printing and BTC price.
                </span>
            </span>
        </h2>

        {% if btc_vs_m2 and btc_vs_m2.dates %}
        <div class="metrics-grid">
            <div class="metric-card" style="border-left: 3px solid #4caf50;">
                <div class="metric-label">M2 Money Supply</div>
                <div class="metric-value">${{ btc_vs_m2.current_m2_trillions }}T</div>
                <div class="metric-sublabel">US M2 (Trillions)</div>
            </div>
            <div class="metric-card {{ 'positive' if btc_vs_m2.m2_yoy_change and btc_vs_m2.m2_yoy_change > 0 else 'negative' if btc_vs_m2.m2_yoy_change and btc_vs_m2.m2_yoy_change < 0 else 'neutral' }}" style="border-left: 3px solid {{ '#4caf50' if btc_vs_m2.m2_yoy_change and btc_vs_m2.m2_yoy_change > 0 else '#f44336' if btc_vs_m2.m2_yoy_change and btc_vs_m2.m2_yoy_change < 0 else '#888' }};">
                <div class="metric-label">M2 YoY Change</div>
                <div class="metric-value">{% if btc_vs_m2.m2_yoy_change is not none %}{{ '+' if btc_vs_m2.m2_yoy_change > 0 else '' }}{{ btc_vs_m2.m2_yoy_change }}%{% else %}N/A{% endif %}</div>
                <div class="metric-sublabel">Money supply growth</div>
            </div>
            <div class="metric-card" style="border-left: 3px solid #f7931a;">
                <div class="metric-label">BTC-M2 Correlation</div>
                <div class="metric-value">{{ btc_vs_m2.correlation }}</div>
                <div class="metric-sublabel">10-year correlation</div>
            </div>
        </div>

        <div class="chart-container" style="height: 400px;">
            <canvas id="btcM2Chart"></canvas>
        </div>

        <div class="explanation-box" style="margin-top: 1rem;">
            <p><strong>How to read:</strong> Both series normalized to 100 at the start. When BTC (orange) rises faster than M2 (green), it's outperforming money supply growth. When M2 expands (green rising), it often precedes BTC rallies. A correlation of {{ btc_vs_m2.correlation }} indicates a {% if btc_vs_m2.correlation > 0.7 %}strong{% elif btc_vs_m2.correlation > 0.4 %}moderate{% else %}weak{% endif %} relationship.</p>
        </div>
        {% else %}
        <p class="text-muted">M2 data not available.</p>
        {% endif %}
    </div>

    <!-- Section 8: Liquidity Indicators -->
    <div class="macro-section">
        <h2>
            Liquidity Environment
            <span class="tooltip">i
                <span class="tooltiptext">
                    <strong>Cash on the Sidelines</strong><br><br>
                    Money Market Funds represent cash waiting to be deployed.<br><br>
                    High MMF + Growing M2 = Abundant liquidity (bullish for risk assets)<br><br>
                    Low MMF + Shrinking M2 = Tight liquidity (headwind for risk assets)
                </span>
            </span>
        </h2>

        {% if liquidity_indicators %}
        <div class="liquidity-status-container" style="background: {{ liquidity_indicators.color }}20; border-left: 4px solid {{ liquidity_indicators.color }};">
            <div class="liquidity-status" style="color: {{ liquidity_indicators.color }};">
                {{ liquidity_indicators.status }}
            </div>
            <p class="liquidity-interpretation">{{ liquidity_indicators.interpretation }}</p>
        </div>

        <div class="metrics-grid" style="margin-top: 1.5rem;">
            {% if liquidity_indicators.m2 %}
            <div class="metric-card" style="border-left: 3px solid #4caf50;">
                <div class="metric-label">M2 Money Supply</div>
                <div class="metric-value">${{ liquidity_indicators.m2.current_trillions }}T</div>
                <div class="metric-sublabel">
                    {% if liquidity_indicators.m2.yoy_change is defined %}
                    YoY: {{ '+' if liquidity_indicators.m2.yoy_change > 0 else '' }}{{ liquidity_indicators.m2.yoy_change }}%
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if liquidity_indicators.money_market %}
            <div class="metric-card" style="border-left: 3px solid #2196f3;">
                <div class="metric-label">Money Market Funds</div>
                <div class="metric-value">${{ liquidity_indicators.money_market.current_trillions }}T</div>
                <div class="metric-sublabel">
                    {% if liquidity_indicators.money_market.near_ath %}
                    <span style="color: #ff9800;">Near All-Time High</span>
                    {% else %}
                    {{ liquidity_indicators.money_market.pct_from_ath }}% from ATH
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if liquidity_indicators.m2 and liquidity_indicators.m2.cagr_5y is defined %}
            <div class="metric-card" style="border-left: 3px solid #9c27b0;">
                <div class="metric-label">M2 5Y CAGR</div>
                <div class="metric-value">{{ liquidity_indicators.m2.cagr_5y }}%</div>
                <div class="metric-sublabel">Annual growth rate</div>
            </div>
            {% endif %}

            {% if liquidity_indicators.money_market and liquidity_indicators.money_market.yoy_change is defined %}
            <div class="metric-card {{ 'positive' if liquidity_indicators.money_market.yoy_change > 0 else 'negative' }}" style="border-left: 3px solid {{ '#4caf50' if liquidity_indicators.money_market.yoy_change > 0 else '#f44336' }};">
                <div class="metric-label">MMF YoY Change</div>
                <div class="metric-value">{{ '+' if liquidity_indicators.money_market.yoy_change > 0 else '' }}{{ liquidity_indicators.money_market.yoy_change }}%</div>
                <div class="metric-sublabel">Cash accumulation</div>
            </div>
            {% endif %}
        </div>

        <div class="explanation-box" style="margin-top: 1rem;">
            <p><strong>Investment Thesis:</strong> When money market funds are at record highs, it means investors are holding large amounts of cash earning low returns. This "dry powder" can fuel significant rallies when sentiment shifts and investors move from cash to risk assets like BTC. Combined with M2 expansion, this creates favorable liquidity conditions for Bitcoin.</p>
        </div>
        {% endif %}
    </div>
</div>

<style>
/* Market Cap Comparison Bar */
.market-cap-comparison {
    margin: 1rem 0;
}

.market-cap-bar-container {
    display: flex;
    height: 50px;
    border-radius: 8px;
    overflow: hidden;
    background: #1a1a1a;
}

.market-cap-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 60px;
    transition: all 0.3s ease;
}

.market-cap-bar:hover {
    filter: brightness(1.2);
}

.bar-label {
    font-size: 0.85rem;
    font-weight: bold;
    color: #000;
    text-shadow: 0 0 2px rgba(255,255,255,0.5);
    white-space: nowrap;
    padding: 0 0.5rem;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
    margin: 1.5rem 0;
}

.metric-card {
    background: #1e1e1e;
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    border: 1px solid #333;
}

.metric-card.neutral {
    border-left: 3px solid #888;
}

.metric-card.positive {
    border-left: 3px solid #4caf50;
}

.metric-card.negative {
    border-left: 3px solid #f44336;
}

.metric-card.warning {
    border-left: 3px solid #ff9800;
}

.metric-label {
    font-size: 0.85rem;
    color: #888;
    margin-bottom: 0.5rem;
}

.metric-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #fff;
}

.metric-sublabel {
    font-size: 0.75rem;
    color: #666;
    margin-top: 0.3rem;
}

.chart-container {
    margin: 1.5rem 0;
    padding: 1rem;
    background: #1a1a1a;
    border-radius: 8px;
}

.explanation-box {
    background: #1e1e1e;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 1rem 1.5rem;
    margin-top: 1.5rem;
}

.explanation-box p {
    color: #aaa;
    line-height: 1.6;
    margin: 0;
}

.explanation-box a {
    color: #f7931a;
}

.explanation-box a:hover {
    text-decoration: underline;
}

/* Timeline Buttons */
.timeline-buttons {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    justify-content: flex-end;
}

.timeline-btn {
    padding: 0.4rem 0.8rem;
    border: 1px solid #444;
    border-radius: 4px;
    background: #1a1a1a;
    color: #888;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s ease;
}

.timeline-btn:hover {
    border-color: #666;
    color: #ccc;
}

.timeline-btn.active {
    background: #f7931a;
    border-color: #f7931a;
    color: #000;
}

/* Halving Cycle Styles */
.halving-container {
    margin: 1rem 0;
}

.cycle-progress-container {
    margin: 1.5rem 0;
}

.cycle-progress-bar {
    height: 24px;
    background: #333;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
}

.cycle-progress-fill {
    height: 100%;
    border-radius: 12px;
    transition: width 0.5s ease;
    position: relative;
}

.cycle-progress-fill::after {
    content: '';
    position: absolute;
    right: 0;
    top: 0;
    height: 100%;
    width: 4px;
    background: #fff;
    border-radius: 2px;
}

.cycle-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 0.5rem;
    font-size: 0.8rem;
    color: #888;
}

/* Liquidity Status */
.liquidity-status-container {
    padding: 1.5rem;
    border-radius: 8px;
    margin: 1rem 0;
}

.liquidity-status {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.liquidity-interpretation {
    color: #ccc;
    margin: 0;
    line-height: 1.6;
}

/* Text color utilities */
.text-muted {
    color: #666;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // BTC Price Chart
    {% if btc_history and btc_history.dates %}
    new Chart(document.getElementById('btcPriceChart'), {
        type: 'line',
        data: {
            labels: {{ btc_history.dates | tojson }},
            datasets: [{
                label: 'BTC Price (USD)',
                data: {{ btc_history.prices | tojson }},
                borderColor: '#f7931a',
                backgroundColor: 'rgba(247, 147, 26, 0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 0,
                pointHoverRadius: 5,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false,
                    title: { display: true, text: 'Price (USD)', color: '#888' },
                    ticks: {
                        color: '#888',
                        callback: function(value) { return '$' + value.toLocaleString(); }
                    },
                    grid: { color: 'rgba(168, 178, 209, 0.1)' }
                },
                x: {
                    ticks: { color: '#888', maxTicksLimit: 12 },
                    grid: { display: false }
                }
            },
            plugins: {
                title: { display: true, text: 'Bitcoin Price History (5 Years)', color: '#f7931a' },
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Price: $' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            }
        }
    });
    {% endif %}

    // Asset Comparison Chart (Normalized) with Dynamic Timeline
    {% if asset_comparison and asset_comparison.datasets %}
    // Store full 5-year raw data (not normalized - we'll normalize based on selected timeframe)
    const fullDates = {{ asset_comparison.dates | tojson }};
    const fullDatasets = [];
    {% for dataset in asset_comparison.datasets %}
    fullDatasets.push({
        key: '{{ dataset.key }}',
        label: '{{ dataset.name }}',
        rawData: {{ dataset.data | tojson }},  // This is normalized to 5y start
        borderColor: '{{ dataset.color }}',
        backgroundColor: 'transparent',
        tension: 0.3,
        pointRadius: 0,
        pointHoverRadius: 5,
        borderWidth: 2
    });
    {% endfor %}

    // Period mappings (approximate weeks)
    const periodWeeks = {
        '1m': 4,
        '3m': 13,
        '6m': 26,
        '1y': 52,
        '3y': 156,
        '5y': 260
    };

    const periodLabels = {
        '1m': '1 Month',
        '3m': '3 Months',
        '6m': '6 Months',
        '1y': '1 Year',
        '3y': '3 Years',
        '5y': '5 Years'
    };

    // Function to filter and re-normalize data for selected timeframe
    function getFilteredData(period) {
        const weeks = periodWeeks[period];
        const startIdx = Math.max(0, fullDates.length - weeks);

        const filteredDates = fullDates.slice(startIdx);
        const filteredDatasets = fullDatasets.map(ds => {
            const slicedData = ds.rawData.slice(startIdx);

            // Re-normalize: set first value to 100, scale others proportionally
            const startVal = slicedData[0];
            const normalizedData = slicedData.map(val => (val / startVal) * 100);

            return {
                label: ds.label,
                data: normalizedData,
                borderColor: ds.borderColor,
                backgroundColor: ds.backgroundColor,
                tension: ds.tension,
                pointRadius: ds.pointRadius,
                pointHoverRadius: ds.pointHoverRadius,
                borderWidth: ds.borderWidth
            };
        });

        return { dates: filteredDates, datasets: filteredDatasets };
    }

    // Create chart with initial 5Y data
    let assetComparisonChart = new Chart(document.getElementById('assetComparisonChart'), {
        type: 'line',
        data: {
            labels: fullDates,
            datasets: fullDatasets.map(ds => ({
                label: ds.label,
                data: ds.rawData.map(val => (val / ds.rawData[0]) * 100),  // Normalize to 100
                borderColor: ds.borderColor,
                backgroundColor: ds.backgroundColor,
                tension: ds.tension,
                pointRadius: ds.pointRadius,
                pointHoverRadius: ds.pointHoverRadius,
                borderWidth: ds.borderWidth
            }))
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: {
                y: {
                    title: { display: true, text: 'Normalized Value (Start = 100)', color: '#888' },
                    ticks: { color: '#888' },
                    grid: { color: 'rgba(168, 178, 209, 0.1)' }
                },
                x: {
                    ticks: { color: '#888', maxTicksLimit: 12 },
                    grid: { display: false }
                }
            },
            plugins: {
                title: { display: true, text: 'Relative Performance (5 Years, Normalized to 100)', color: '#ccc' },
                legend: {
                    display: true,
                    labels: { color: '#ccc' }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const change = (context.parsed.y - 100).toFixed(1);
                            const sign = change >= 0 ? '+' : '';
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + ' (' + sign + change + '%)';
                        }
                    }
                }
            }
        }
    });

    // Timeline button click handlers
    document.querySelectorAll('.timeline-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active state
            document.querySelectorAll('.timeline-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            const period = this.dataset.period;
            const filtered = getFilteredData(period);

            // Update chart
            assetComparisonChart.data.labels = filtered.dates;
            assetComparisonChart.data.datasets = filtered.datasets;
            assetComparisonChart.options.plugins.title.text = `Relative Performance (${periodLabels[period]}, Normalized to 100)`;
            assetComparisonChart.update();
        });
    });
    {% endif %}

    // BTC vs M2 Money Supply Chart
    {% if btc_vs_m2 and btc_vs_m2.dates %}
    new Chart(document.getElementById('btcM2Chart'), {
        type: 'line',
        data: {
            labels: {{ btc_vs_m2.dates | tojson }},
            datasets: [
                {
                    label: 'Bitcoin (Normalized)',
                    data: {{ btc_vs_m2.btc_normalized | tojson }},
                    borderColor: '#f7931a',
                    backgroundColor: 'rgba(247, 147, 26, 0.1)',
                    fill: false,
                    tension: 0.3,
                    pointRadius: 0,
                    pointHoverRadius: 5,
                    borderWidth: 2,
                    yAxisID: 'y'
                },
                {
                    label: 'M2 Money Supply (Normalized)',
                    data: {{ btc_vs_m2.m2_normalized | tojson }},
                    borderColor: '#4caf50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    fill: false,
                    tension: 0.3,
                    pointRadius: 0,
                    pointHoverRadius: 5,
                    borderWidth: 2,
                    yAxisID: 'y'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: {
                y: {
                    type: 'logarithmic',
                    title: { display: true, text: 'Normalized Value (Log Scale, Start = 100)', color: '#888' },
                    ticks: { color: '#888' },
                    grid: { color: 'rgba(168, 178, 209, 0.1)' }
                },
                x: {
                    ticks: { color: '#888', maxTicksLimit: 12 },
                    grid: { display: false }
                }
            },
            plugins: {
                title: { display: true, text: 'Bitcoin vs M2 Money Supply (10 Years, Normalized)', color: '#ccc' },
                legend: {
                    display: true,
                    labels: { color: '#ccc' }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const change = (context.parsed.y - 100).toFixed(1);
                            const sign = change >= 0 ? '+' : '';
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(0) + ' (' + sign + change + '%)';
                        }
                    }
                }
            }
        }
    });
    {% endif %}
});
</script>
{% endblock %}
