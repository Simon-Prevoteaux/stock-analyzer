{% extends "base.html" %}

{% block title %}Rates & Spreads - Macro Signals{% endblock %}

{% block content %}
<div class="macro-dashboard">
    <div class="page-header">
        <h1>Rates & Spreads</h1>
        <p class="subtitle">Yield curve, Treasury spreads, and corporate credit spreads</p>
        {% if last_update %}
        <p class="last-update">Last updated: {{ last_update }}</p>
        {% endif %}
    </div>

    <!-- Recession Indicators -->
    {% if recession_indicators %}
    <div class="recession-indicators">
        <h3>
            Recession Indicators
            <span class="tooltip">i
                <span class="tooltiptext">
                    Yield curve inversions historically precede recessions by 12-18 months.
                    Multiple inverted spreads increase recession probability.
                </span>
            </span>
        </h3>
        <div class="indicator-summary {{ recession_indicators.risk_class }}">
            <div class="risk-level">Risk Level: <strong>{{ recession_indicators.risk_level }}</strong></div>
            <div class="risk-summary">{{ recession_indicators.summary }}</div>
            {% if recession_indicators.signals %}
            <ul class="risk-signals">
                {% for signal in recession_indicators.signals %}
                <li>{{ signal }}</li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Section 1: Yield Curve -->
    <div class="macro-section" id="rates">
        <h2>
            US Treasury Yield Curve
            <span class="tooltip">i
                <span class="tooltiptext">
                    <strong>Understanding the yield curve:</strong><br><br>
                    <strong>Normal Curve:</strong> Long-term rates > short-term rates<br>
                    Healthy economy expected, investors want premium for longer commitment<br><br>
                    <strong>Flat Curve:</strong> Similar rates across maturities<br>
                    Uncertain economic outlook, transition phase<br><br>
                    <strong>Inverted Curve:</strong> Short-term rates > long-term rates<br>
                    RECESSION WARNING. Investors expect Fed to cut rates due to weakness<br><br>
                    <strong>Key indicator:</strong> The 10Y-2Y spread has preceded every recession
                    since 1970 when it turns negative.
                </span>
            </span>
        </h2>

        <!-- Yield Curve Chart -->
        <div class="chart-container">
            <canvas id="yieldCurveChart"></canvas>
        </div>

        <!-- Key Spreads Table -->
        <h3 class="subsection-header">Key Yield Spreads</h3>
        <table class="spreads-table">
            <thead>
                <tr>
                    <th>Spread</th>
                    <th>Current</th>
                    <th>1M Ago</th>
                    <th>3M Ago</th>
                    <th>6M Ago</th>
                    <th>1Y Ago</th>
                    <th>Trend
                        <span class="tooltip">i
                            <span class="tooltiptext">
                                <strong>EXPANDING</strong>: Spread widening (getting steeper/less inverted)<br>
                                <strong>CONTRACTING</strong>: Spread narrowing (getting flatter/more inverted)<br>
                                <strong>STABLE</strong>: Little change over past 3 months
                            </span>
                        </span>
                    </th>
                    <th>Status</th>
                    <th>Interpretation</th>
                </tr>
            </thead>
            <tbody>
                {% if spreads.get('10y2y') %}
                <tr class="spread-row-{{ spreads['10y2y'].status_class }}">
                    <td><strong>10Y - 2Y</strong>
                        <span class="tooltip">i
                            <span class="tooltiptext">
                                The most watched recession indicator. When negative, it has preceded
                                every US recession since 1970, typically by 12-24 months.
                            </span>
                        </span>
                    </td>
                    <td><strong>{{ spreads['10y2y'].current }}%</strong></td>
                    <td>
                        {{ spreads['10y2y']['1m_ago'] if spreads['10y2y'].get('1m_ago') else 'N/A' }}
                        {% if spreads['10y2y'].get('change_1m') %}
                            <br><span class="{{ 'positive' if spreads['10y2y'].change_1m > 0 else 'negative' if spreads['10y2y'].change_1m < 0 else '' }}" style="font-size: 0.85em;">
                                ({% if spreads['10y2y'].change_1m >= 0 %}+{% endif %}{{ spreads['10y2y'].change_1m }}%)
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {{ spreads['10y2y']['3m_ago'] if spreads['10y2y'].get('3m_ago') else 'N/A' }}
                        {% if spreads['10y2y'].get('change_3m') %}
                            <br><span class="{{ 'positive' if spreads['10y2y'].change_3m > 0 else 'negative' if spreads['10y2y'].change_3m < 0 else '' }}" style="font-size: 0.85em;">
                                ({% if spreads['10y2y'].change_3m >= 0 %}+{% endif %}{{ spreads['10y2y'].change_3m }}%)
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {{ spreads['10y2y']['6m_ago'] if spreads['10y2y'].get('6m_ago') else 'N/A' }}
                        {% if spreads['10y2y'].get('change_6m') %}
                            <br><span class="{{ 'positive' if spreads['10y2y'].change_6m > 0 else 'negative' if spreads['10y2y'].change_6m < 0 else '' }}" style="font-size: 0.85em;">
                                ({% if spreads['10y2y'].change_6m >= 0 %}+{% endif %}{{ spreads['10y2y'].change_6m }}%)
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {{ spreads['10y2y']['1y_ago'] if spreads['10y2y'].get('1y_ago') else 'N/A' }}
                        {% if spreads['10y2y'].get('change_1y') %}
                            <br><span class="{{ 'positive' if spreads['10y2y'].change_1y > 0 else 'negative' if spreads['10y2y'].change_1y < 0 else '' }}" style="font-size: 0.85em;">
                                ({% if spreads['10y2y'].change_1y >= 0 %}+{% endif %}{{ spreads['10y2y'].change_1y }}%)
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if spreads['10y2y'].get('trend') %}
                            <span class="trend-badge trend-{{ spreads['10y2y'].trend.lower() }}">
                                {{ spreads['10y2y'].trend }}
                            </span>
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td class="status-badge {{ spreads['10y2y'].status_class }}">
                        {{ spreads['10y2y'].status }}
                    </td>
                    <td>{{ spreads['10y2y'].interpretation }}</td>
                </tr>
                {% endif %}

                {% if spreads.get('10y3m') %}
                <tr class="spread-row-{{ spreads['10y3m'].status_class }}">
                    <td><strong>10Y - 3M</strong>
                        <span class="tooltip">i
                            <span class="tooltiptext">
                                Alternative recession indicator. Measures difference between long-term
                                bonds and very short-term rates (close to Fed funds rate).
                            </span>
                        </span>
                    </td>
                    <td><strong>{{ spreads['10y3m'].current }}%</strong></td>
                    <td>
                        {{ spreads['10y3m']['1m_ago'] if spreads['10y3m'].get('1m_ago') else 'N/A' }}
                        {% if spreads['10y3m'].get('change_1m') %}
                            <br><span class="{{ 'positive' if spreads['10y3m'].change_1m > 0 else 'negative' if spreads['10y3m'].change_1m < 0 else '' }}" style="font-size: 0.85em;">
                                ({% if spreads['10y3m'].change_1m >= 0 %}+{% endif %}{{ spreads['10y3m'].change_1m }}%)
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {{ spreads['10y3m']['3m_ago'] if spreads['10y3m'].get('3m_ago') else 'N/A' }}
                        {% if spreads['10y3m'].get('change_3m') %}
                            <br><span class="{{ 'positive' if spreads['10y3m'].change_3m > 0 else 'negative' if spreads['10y3m'].change_3m < 0 else '' }}" style="font-size: 0.85em;">
                                ({% if spreads['10y3m'].change_3m >= 0 %}+{% endif %}{{ spreads['10y3m'].change_3m }}%)
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {{ spreads['10y3m']['6m_ago'] if spreads['10y3m'].get('6m_ago') else 'N/A' }}
                        {% if spreads['10y3m'].get('change_6m') %}
                            <br><span class="{{ 'positive' if spreads['10y3m'].change_6m > 0 else 'negative' if spreads['10y3m'].change_6m < 0 else '' }}" style="font-size: 0.85em;">
                                ({% if spreads['10y3m'].change_6m >= 0 %}+{% endif %}{{ spreads['10y3m'].change_6m }}%)
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {{ spreads['10y3m']['1y_ago'] if spreads['10y3m'].get('1y_ago') else 'N/A' }}
                        {% if spreads['10y3m'].get('change_1y') %}
                            <br><span class="{{ 'positive' if spreads['10y3m'].change_1y > 0 else 'negative' if spreads['10y3m'].change_1y < 0 else '' }}" style="font-size: 0.85em;">
                                ({% if spreads['10y3m'].change_1y >= 0 %}+{% endif %}{{ spreads['10y3m'].change_1y }}%)
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if spreads['10y3m'].get('trend') %}
                            <span class="trend-badge trend-{{ spreads['10y3m'].trend.lower() }}">
                                {{ spreads['10y3m'].trend }}
                            </span>
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td class="status-badge {{ spreads['10y3m'].status_class }}">
                        {{ spreads['10y3m'].status }}
                    </td>
                    <td>{{ spreads['10y3m'].interpretation }}</td>
                </tr>
                {% endif %}

                {% if spreads.get('30y5y') %}
                <tr class="spread-row-{{ spreads['30y5y'].status_class }}">
                    <td><strong>30Y - 5Y</strong>
                        <span class="tooltip">i
                            <span class="tooltiptext">
                                Measures the long-end of the curve. A wide spread suggests higher
                                term premium or inflation expectations for the distant future.
                            </span>
                        </span>
                    </td>
                    <td><strong>{{ spreads['30y5y'].current }}%</strong></td>
                    <td>
                        {{ spreads['30y5y']['1m_ago'] if spreads['30y5y'].get('1m_ago') else 'N/A' }}
                        {% if spreads['30y5y'].get('change_1m') %}
                            <br><span class="{{ 'positive' if spreads['30y5y'].change_1m > 0 else 'negative' if spreads['30y5y'].change_1m < 0 else '' }}" style="font-size: 0.85em;">
                                ({% if spreads['30y5y'].change_1m >= 0 %}+{% endif %}{{ spreads['30y5y'].change_1m }}%)
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {{ spreads['30y5y']['3m_ago'] if spreads['30y5y'].get('3m_ago') else 'N/A' }}
                        {% if spreads['30y5y'].get('change_3m') %}
                            <br><span class="{{ 'positive' if spreads['30y5y'].change_3m > 0 else 'negative' if spreads['30y5y'].change_3m < 0 else '' }}" style="font-size: 0.85em;">
                                ({% if spreads['30y5y'].change_3m >= 0 %}+{% endif %}{{ spreads['30y5y'].change_3m }}%)
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {{ spreads['30y5y']['6m_ago'] if spreads['30y5y'].get('6m_ago') else 'N/A' }}
                        {% if spreads['30y5y'].get('change_6m') %}
                            <br><span class="{{ 'positive' if spreads['30y5y'].change_6m > 0 else 'negative' if spreads['30y5y'].change_6m < 0 else '' }}" style="font-size: 0.85em;">
                                ({% if spreads['30y5y'].change_6m >= 0 %}+{% endif %}{{ spreads['30y5y'].change_6m }}%)
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {{ spreads['30y5y']['1y_ago'] if spreads['30y5y'].get('1y_ago') else 'N/A' }}
                        {% if spreads['30y5y'].get('change_1y') %}
                            <br><span class="{{ 'positive' if spreads['30y5y'].change_1y > 0 else 'negative' if spreads['30y5y'].change_1y < 0 else '' }}" style="font-size: 0.85em;">
                                ({% if spreads['30y5y'].change_1y >= 0 %}+{% endif %}{{ spreads['30y5y'].change_1y }}%)
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if spreads['30y5y'].get('trend') %}
                            <span class="trend-badge trend-{{ spreads['30y5y'].trend.lower() }}">
                                {{ spreads['30y5y'].trend }}
                            </span>
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td class="status-badge {{ spreads['30y5y'].status_class }}">
                        {{ spreads['30y5y'].status }}
                    </td>
                    <td>{{ spreads['30y5y'].interpretation }}</td>
                </tr>
                {% endif %}
            </tbody>
        </table>

        <!-- Historical Spread Chart -->
        <h3 class="subsection-header">Historical Spread Trends (Past Year)</h3>
        <p class="table-description">
            Track how spreads have evolved over time. Negative values indicate inversion. The zero line marks the transition between normal and inverted curves.
        </p>
        <div class="chart-container">
            <canvas id="spreadHistoryChart"></canvas>
        </div>

        <div class="explanation-box">
            <p><strong>Ray Dalio's debt concern:</strong> With nearly $10 trillion in debt to roll over and potential Fed easing, the yield curve may steepen. This is especially concerning if it steepens from current levels due to supply/demand imbalances rather than improved growth expectations.</p>
        </div>
    </div>

    <!-- Section 2: Credit Spreads -->
    <div class="macro-section">
        <h2>
            Corporate Credit Spreads
            <span class="tooltip">i
                <span class="tooltiptext">
                    <strong>What are credit spreads?</strong><br><br>
                    Credit spreads measure the extra yield (in basis points) investors demand
                    for corporate bonds vs risk-free Treasuries.<br><br>
                    <strong>Low/Tight spreads:</strong><br>
                    - Investors comfortable with risk<br>
                    - High risk appetite, complacency<br>
                    - Limited downside protection<br>
                    - Little room to tighten further<br><br>
                    <strong>High/Wide spreads:</strong><br>
                    - Rising credit concerns<br>
                    - Economic stress or recession fears<br>
                    - Better entry points for credit<br><br>
                    <strong>Ray Dalio's warning:</strong> "Credit spreads contracted to very low
                    levels in 2025... leaves these spreads less likely to decline and more likely
                    to rise, which is a negative for these assets."
                </span>
            </span>
        </h2>

        <table class="spreads-table">
            <thead>
                <tr>
                    <th>Credit Type</th>
                    <th>Current (bps)</th>
                    <th>Historical Percentile</th>
                    <th>Interpretation</th>
                </tr>
            </thead>
            <tbody>
                {% if credit_spreads.get('bbb') %}
                <tr>
                    <td>
                        <strong>Investment Grade (BBB)</strong>
                        <span class="tooltip">i
                            <span class="tooltiptext">
                                BBB-rated corporate bonds - the lowest investment grade rating.
                                "Fallen angels" drop below this to high yield. Watch for widening
                                as a sign of credit quality deterioration.
                            </span>
                        </span>
                    </td>
                    <td>{{ credit_spreads['bbb'].current }} bps</td>
                    <td>
                        <div class="percentile-bar">
                            <div class="percentile-fill" style="width: {{ credit_spreads['bbb'].percentile }}%"></div>
                            <span class="percentile-text">{{ credit_spreads['bbb'].percentile }}th percentile</span>
                        </div>
                    </td>
                    <td>{{ credit_spreads['bbb'].interpretation }}</td>
                </tr>
                {% endif %}

                {% if credit_spreads.get('high_yield') %}
                <tr>
                    <td>
                        <strong>High Yield</strong>
                        <span class="tooltip">i
                            <span class="tooltiptext">
                                "Junk bonds" below investment grade (BB+ and lower).
                                More sensitive to economic cycles and default risk.
                                Wide spreads can signal economic stress or opportunity.
                            </span>
                        </span>
                    </td>
                    <td>{{ credit_spreads['high_yield'].current }} bps</td>
                    <td>
                        <div class="percentile-bar">
                            <div class="percentile-fill" style="width: {{ credit_spreads['high_yield'].percentile }}%"></div>
                            <span class="percentile-text">{{ credit_spreads['high_yield'].percentile }}th percentile</span>
                        </div>
                    </td>
                    <td>{{ credit_spreads['high_yield'].interpretation }}</td>
                </tr>
                {% endif %}

                {% if credit_spreads.get('corporate_master') %}
                <tr>
                    <td>
                        <strong>Corporate Master</strong>
                        <span class="tooltip">i
                            <span class="tooltiptext">
                                Broad index of all US corporate bonds (investment grade).
                                Represents average credit spread for corporate debt market.
                            </span>
                        </span>
                    </td>
                    <td>{{ credit_spreads['corporate_master'].current }} bps</td>
                    <td>
                        <div class="percentile-bar">
                            <div class="percentile-fill" style="width: {{ credit_spreads['corporate_master'].percentile }}%"></div>
                            <span class="percentile-text">{{ credit_spreads['corporate_master'].percentile }}th percentile</span>
                        </div>
                    </td>
                    <td>{{ credit_spreads['corporate_master'].interpretation }}</td>
                </tr>
                {% endif %}
            </tbody>
        </table>

        <div class="explanation-box">
            <p><strong>Understanding percentiles:</strong> A 15th percentile means the current spread is lower (tighter) than 85% of historical readings - very compressed. An 85th percentile means spreads are wider than usual - elevated risk or opportunity depending on fundamentals.</p>
        </div>
    </div>

    <!-- Refresh Button -->
    <div class="actions">
        <button id="refresh-data" class="btn btn-primary" onclick="location.reload();">Refresh Data</button>
    </div>
</div>

<!-- Include Chart.js script -->
<script src="{{ url_for('static', filename='js/macro_signals.js') }}"></script>
<script>
// Pass yield curve data to JavaScript
const yieldCurveData = {
    maturities: ['1M', '3M', '6M', '1Y', '2Y', '3Y', '5Y', '7Y', '10Y', '20Y', '30Y'],
    yields: [
        {{ yield_curve.get('1M') if yield_curve.get('1M') else 'null' }},
        {{ yield_curve.get('3M') if yield_curve.get('3M') else 'null' }},
        {{ yield_curve.get('6M') if yield_curve.get('6M') else 'null' }},
        {{ yield_curve.get('1Y') if yield_curve.get('1Y') else 'null' }},
        {{ yield_curve.get('2Y') if yield_curve.get('2Y') else 'null' }},
        {{ yield_curve.get('3Y') if yield_curve.get('3Y') else 'null' }},
        {{ yield_curve.get('5Y') if yield_curve.get('5Y') else 'null' }},
        {{ yield_curve.get('7Y') if yield_curve.get('7Y') else 'null' }},
        {{ yield_curve.get('10Y') if yield_curve.get('10Y') else 'null' }},
        {{ yield_curve.get('20Y') if yield_curve.get('20Y') else 'null' }},
        {{ yield_curve.get('30Y') if yield_curve.get('30Y') else 'null' }}
    ]
};

// Render charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    renderYieldCurve(yieldCurveData);

    // Render spread history chart
    const spreadHistoryData = {
        dates: {{ spread_history.dates | tojson }},
        spreads: {
            '10y2y': {{ spread_history['10y2y'] | tojson }},
            '10y3m': {{ spread_history['10y3m'] | tojson }},
            '30y5y': {{ spread_history['30y5y'] | tojson }}
        }
    };
    renderSpreadHistory(spreadHistoryData);
});
</script>
{% endblock %}
