{% extends "base.html" %}

{% block title %}Upside Calculator - Stock Analyzer{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Upside Calculator</h2>
    <p class="subtitle">Calculate potential upside to target market cap and required growth rates</p>
</div>

<!-- Target Market Cap Setting -->
<div class="card">
    <h3>Set Target Market Cap</h3>
    <form method="get" action="{{ url_for('upside_calculator') }}" class="upside-form">
        <div class="form-group">
            <label for="target">Target Market Cap (Billions):</label>
            <input type="number"
                   id="target"
                   name="target"
                   value="{{ target_market_cap_b }}"
                   step="1"
                   min="0.01"
                   max="100000"
                   class="target-input">
            <button type="submit" class="btn btn-primary">Calculate Upside</button>
        </div>
        <div class="quick-targets">
            <span>Quick targets:</span>
            <button type="button" onclick="setTarget(10)" class="btn-sm">$10B</button>
            <button type="button" onclick="setTarget(100)" class="btn-sm">$100B</button>
            <button type="button" onclick="setTarget(500)" class="btn-sm">$500B</button>
            <button type="button" onclick="setTarget(1000)" class="btn-sm">$1T</button>
            <button type="button" onclick="setTarget(2000)" class="btn-sm">$2T</button>
            <button type="button" onclick="setTarget(5000)" class="btn-sm">$5T</button>
        </div>
    </form>
</div>

<!-- Two Column Layout -->
<div class="upside-layout">
    <!-- Left Column: Stock List -->
    <div class="stock-list-panel">
        <div class="card">
            <h3>Stocks Ranked by Upside Potential</h3>
            <p class="info-text">Target: <strong>${{ '{:,.0f}'.format(target_market_cap_b) }}B</strong></p>

            {% if stocks %}
            <div class="table-container">
                <table class="stock-table sortable-table" id="upsideTable">
                    <thead>
                        <tr>
                            <th data-sortable data-type="text">Ticker</th>
                            <th data-sortable data-type="text">Company</th>
                            <th data-sortable data-type="number">Current MC</th>
                            <th data-sortable data-type="number">Upside</th>
                            <th data-sortable data-type="number">Multiple</th>
                            <th data-sortable data-type="number">Target Price</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stock in stocks %}
                        <tr class="stock-row {% if loop.index0 == 0 %}selected{% endif %}"
                            data-ticker="{{ stock.ticker }}"
                            onclick="selectStock('{{ stock.ticker }}', {{ stock.current_market_cap }}, {{ stock.upside_multiple }}, {{ stock.current_price }}, {{ stock.target_price }}, '{{ stock.company_name }}', {{ stock.target_market_cap }})">
                            <td><strong>{{ stock.ticker }}</strong></td>
                            <td class="company-name">{{ stock.company_name }}</td>
                            <td>{{ stock.current_market_cap|format_number }}</td>
                            <td class="upside-cell">
                                <span class="upside-badge {% if stock.upside_percent > 1000 %}extreme{% elif stock.upside_percent > 500 %}very-high{% elif stock.upside_percent > 100 %}high{% else %}moderate{% endif %}">
                                    +{{ stock.upside_percent|round(0)|int }}%
                                </span>
                            </td>
                            <td>{{ stock.upside_multiple|round(1) }}x</td>
                            <td>${{ stock.target_price|round(2) }}</td>
                            <td>
                                <button class="btn-sm btn-select" onclick="event.stopPropagation(); selectStock('{{ stock.ticker }}', {{ stock.current_market_cap }}, {{ stock.upside_multiple }}, {{ stock.current_price }}, {{ stock.target_price }}, '{{ stock.company_name }}', {{ stock.target_market_cap }})">
                                    Select
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="no-data">No stocks available. Please fetch some stock data first.</p>
            {% endif %}
        </div>
    </div>

    <!-- Right Column: Selected Stock Details & Charts -->
    <div class="details-panel">
        <!-- Selected Stock Info -->
        <div class="card" id="selectedStockCard">
            <h3>Selected Stock: <span id="selectedTicker">{{ stocks[0].ticker if stocks else 'None' }}</span></h3>
            <div class="stock-details">
                <div class="detail-row">
                    <span class="label">Company:</span>
                    <span id="selectedCompany">{{ stocks[0].company_name if stocks else 'N/A' }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Current Market Cap:</span>
                    <span id="selectedCurrentMC">{{ stocks[0].current_market_cap|format_number if stocks else 'N/A' }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Current Price:</span>
                    <span id="selectedCurrentPrice">${{ stocks[0].current_price|round(2) if stocks else 'N/A' }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Target Market Cap:</span>
                    <span id="selectedTargetMC">{{ stocks[0].target_market_cap|format_number if stocks else 'N/A' }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Target Price:</span>
                    <span id="selectedTargetPrice" class="highlight">${{ stocks[0].target_price|round(2) if stocks else 'N/A' }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Upside:</span>
                    <span id="selectedUpside" class="highlight-green">+{{ (stocks[0].upside_percent|round(0)|int) if stocks else 'N/A' }}%</span>
                </div>
                <div class="detail-row">
                    <span class="label">Multiple:</span>
                    <span id="selectedMultiple">{{ stocks[0].upside_multiple|round(2) if stocks else 'N/A' }}x</span>
                </div>
            </div>
        </div>

        <!-- Upside Visualization Chart -->
        <div class="card">
            <h3>Market Cap Progression</h3>
            <canvas id="upsideChart" width="400" height="250"></canvas>
        </div>

        <!-- Reverse Calculator: Required Growth Rate -->
        <div class="card">
            <h3>Required Growth Calculator</h3>
            <p class="info-text">What annual growth rate is needed to reach the target?</p>

            <div class="growth-calculator">
                <div class="form-group">
                    <label for="timeframe">Timeframe (years):</label>
                    <input type="number" id="timeframe" value="5" min="1" max="30" class="input-sm">
                    <button onclick="calculateRequiredGrowth()" class="btn btn-primary">Calculate</button>
                </div>

                <div id="growthResults" class="growth-results" style="display: none;">
                    <div class="result-box">
                        <h4>Required Annual Growth (CAGR)</h4>
                        <div class="big-number" id="requiredCAGR">-</div>
                    </div>

                    <div class="comparison-section">
                        <h4>Historical Growth Comparison</h4>
                        <div class="comparison-grid">
                            <div class="comparison-item">
                                <span class="label">Revenue CAGR (3Y):</span>
                                <span id="historicalRevenue" class="value">-</span>
                            </div>
                            <div class="comparison-item">
                                <span class="label">Earnings CAGR (3Y):</span>
                                <span id="historicalEarnings" class="value">-</span>
                            </div>
                            <div class="comparison-item feasibility">
                                <span class="label">Feasibility:</span>
                                <span id="feasibility" class="value">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="progression-section">
                        <h4>Year-by-Year Progression</h4>
                        <canvas id="progressionChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let currentTicker = '{{ stocks[0].ticker if stocks else "" }}';
let currentMC = {{ stocks[0].current_market_cap if stocks else 0 }};
let targetMC = {{ stocks[0].target_market_cap if stocks else 0 }};  // Will be updated on page load and stock selection
let upsideChart = null;
let progressionChart = null;

// Set target value
function setTarget(value) {
    document.getElementById('target').value = value;
    document.querySelector('.upside-form').submit();
}

// Select a stock
function selectStock(ticker, currentMarketCap, upsideMultiple, currentPrice, targetPrice, companyName, targetMarketCap) {
    // Remove previous selection
    document.querySelectorAll('.stock-row').forEach(row => row.classList.remove('selected'));

    // Add selection to clicked row
    const row = document.querySelector(`tr[data-ticker="${ticker}"]`);
    if (row) row.classList.add('selected');

    // Update global variables
    currentTicker = ticker;
    currentMC = currentMarketCap;
    targetMC = targetMarketCap;

    // Update details panel
    document.getElementById('selectedTicker').textContent = ticker;
    document.getElementById('selectedCompany').textContent = companyName;
    document.getElementById('selectedCurrentMC').textContent = formatNumber(currentMarketCap);
    document.getElementById('selectedCurrentPrice').textContent = '$' + currentPrice.toFixed(2);
    document.getElementById('selectedTargetMC').textContent = formatNumber(targetMarketCap);
    document.getElementById('selectedTargetPrice').textContent = '$' + targetPrice.toFixed(2);
    document.getElementById('selectedUpside').textContent = '+' + ((upsideMultiple - 1) * 100).toFixed(0) + '%';
    document.getElementById('selectedMultiple').textContent = upsideMultiple.toFixed(2) + 'x';

    // Update chart
    updateUpsideChart(ticker, currentMarketCap, targetMarketCap);

    // Hide growth results (will recalculate when user clicks)
    document.getElementById('growthResults').style.display = 'none';
}

// Update upside visualization chart
function updateUpsideChart(ticker, current, target) {
    const ctx = document.getElementById('upsideChart').getContext('2d');

    // Destroy existing chart
    if (upsideChart) {
        upsideChart.destroy();
    }

    // Create new chart
    upsideChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Current Market Cap', 'Target Market Cap'],
            datasets: [{
                label: ticker,
                data: [current, target],
                backgroundColor: ['#4a90e2', '#00ff88'],
                borderColor: ['#357abd', '#00cc6a'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return formatNumber(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatNumberShort(value);
                        }
                    }
                }
            }
        }
    });
}

// Calculate required growth rate
async function calculateRequiredGrowth() {
    const years = parseInt(document.getElementById('timeframe').value);

    if (!currentTicker) {
        alert('Please select a stock first');
        return;
    }

    if (!targetMC || targetMC <= 0) {
        alert('Invalid target market cap. Please set a target.');
        return;
    }

    try {
        const url = `/api/calculate-required-growth?ticker=${currentTicker}&target_mc=${targetMC}&years=${years}`;
        console.log('Fetching:', url);  // Debug log

        const response = await fetch(url);

        if (!response.ok) {
            const errorData = await response.json();
            alert(errorData.error || 'Failed to calculate required growth rate');
            return;
        }

        const data = await response.json();

        if (data.error) {
            alert(data.error);
            return;
        }

        // Display results
        document.getElementById('growthResults').style.display = 'block';
        document.getElementById('requiredCAGR').textContent = (data.required_cagr * 100).toFixed(1) + '%';

        // Historical comparison - handle null, undefined, and 0
        document.getElementById('historicalRevenue').textContent =
            (data.historical_revenue_cagr !== null && data.historical_revenue_cagr !== undefined && data.historical_revenue_cagr > 0)
                ? (data.historical_revenue_cagr * 100).toFixed(1) + '%'
                : 'N/A';
        document.getElementById('historicalEarnings').textContent =
            (data.historical_earnings_cagr !== null && data.historical_earnings_cagr !== undefined && data.historical_earnings_cagr > 0)
                ? (data.historical_earnings_cagr * 100).toFixed(1) + '%'
                : 'N/A';

        // Feasibility assessment
        const feasibilityEl = document.getElementById('feasibility');
        if (data.is_feasible === true) {
            feasibilityEl.textContent = 'Achievable';
            feasibilityEl.className = 'value feasible';
        } else if (data.is_feasible === false) {
            feasibilityEl.textContent = 'Ambitious';
            feasibilityEl.className = 'value ambitious';
        } else {
            feasibilityEl.textContent = 'Unknown';
            feasibilityEl.className = 'value';
        }

        // Update progression chart
        updateProgressionChart(data.progression, data.company_name);

    } catch (error) {
        console.error('Error calculating required growth:', error);
        alert('Failed to calculate required growth rate. Check console for details.');
    }
}

// Update year-by-year progression chart
function updateProgressionChart(progression, companyName) {
    const ctx = document.getElementById('progressionChart').getContext('2d');

    // Destroy existing chart
    if (progressionChart) {
        progressionChart.destroy();
    }

    const labels = progression.map(p => `Year ${p.year}`);
    const mcData = progression.map(p => p.market_cap);
    const priceData = progression.map(p => p.price);

    progressionChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Market Cap',
                    data: mcData,
                    borderColor: '#00ff88',
                    backgroundColor: 'rgba(0, 255, 136, 0.1)',
                    yAxisID: 'y',
                    tension: 0.3,
                    fill: true
                },
                {
                    label: 'Stock Price',
                    data: priceData,
                    borderColor: '#ffd700',
                    backgroundColor: 'rgba(255, 215, 0, 0.1)',
                    yAxisID: 'y1',
                    tension: 0.3,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                title: {
                    display: true,
                    text: `${companyName} - Projected Growth Path`
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Market Cap'
                    },
                    ticks: {
                        callback: function(value) {
                            return formatNumberShort(value);
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Stock Price ($)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toFixed(2);
                        }
                    }
                }
            }
        }
    });
}

// Format number helper
function formatNumber(value) {
    if (!value) return 'N/A';

    if (value >= 1e12) {
        return '$' + (value / 1e12).toFixed(2) + 'T';
    } else if (value >= 1e9) {
        return '$' + (value / 1e9).toFixed(2) + 'B';
    } else if (value >= 1e6) {
        return '$' + (value / 1e6).toFixed(2) + 'M';
    } else if (value >= 1e3) {
        return '$' + (value / 1e3).toFixed(2) + 'K';
    }
    return '$' + value.toFixed(2);
}

function formatNumberShort(value) {
    if (value >= 1e12) {
        return (value / 1e12).toFixed(1) + 'T';
    } else if (value >= 1e9) {
        return (value / 1e9).toFixed(1) + 'B';
    } else if (value >= 1e6) {
        return (value / 1e6).toFixed(1) + 'M';
    }
    return value.toFixed(0);
}

// Initialize chart on page load
document.addEventListener('DOMContentLoaded', function() {
    {% if stocks %}
    // Set initial targetMC value
    targetMC = {{ stocks[0].target_market_cap }};
    updateUpsideChart('{{ stocks[0].ticker }}', {{ stocks[0].current_market_cap }}, {{ stocks[0].target_market_cap }});
    {% endif %}
});
</script>

{% endblock %}
