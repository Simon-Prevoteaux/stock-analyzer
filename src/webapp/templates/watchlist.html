{% extends "base.html" %}

{% block title %}Watchlist{% endblock %}

{% block content %}
<h1>My Watchlist</h1>

{% if stocks %}
<div class="table-container">
    <table class="stock-table sortable-table">
        <thead>
            <tr>
                <th data-sortable data-type="number">Ranking</th>
                <th data-sortable data-type="text">Ticker</th>
                <th data-sortable data-type="text">Company</th>
                <th data-sortable data-type="number">Current Price</th>
                <th data-sortable data-type="number">Market Cap</th>
                <th data-sortable data-type="number">P/E</th>
                <th data-sortable data-type="number">P/S</th>
                <th data-sortable data-type="number">PEG Avg</th>
                <th data-sortable data-type="number">Growth</th>
                <th data-sortable data-type="text">Risk Level</th>
                <th data-sortable data-type="text">Added</th>
                <th>Notes</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for stock in stocks %}
            <tr data-ticker="{{ stock.ticker }}">
                <td>
                    <select class="ranking-select" data-ticker="{{ stock.ticker }}" onchange="updateRanking('{{ stock.ticker }}', this.value)">
                        <option value="0" {% if not stock.ranking or stock.ranking == 0 %}selected{% endif %}>None</option>
                        <option value="1" {% if stock.ranking == 1 %}selected{% endif %}>⭐</option>
                        <option value="2" {% if stock.ranking == 2 %}selected{% endif %}>⭐⭐</option>
                        <option value="3" {% if stock.ranking == 3 %}selected{% endif %}>⭐⭐⭐</option>
                        <option value="4" {% if stock.ranking == 4 %}selected{% endif %}>⭐⭐⭐⭐</option>
                        <option value="5" {% if stock.ranking == 5 %}selected{% endif %}>⭐⭐⭐⭐⭐</option>
                    </select>
                </td>
                <td><a href="{{ url_for('stock_detail', ticker=stock.ticker) }}">{{ stock.ticker }}</a></td>
                <td>{{ stock.company_name }}</td>
                <td>${{ stock.current_price }}</td>
                <td>{{ stock.market_cap|format_number }}</td>
                <td>{{ stock.pe_ratio|format_ratio }}</td>
                <td>{{ stock.ps_ratio|format_ratio }}</td>
                <td>
                    {% if stock.peg_average %}
                        <span style="color: {% if stock.peg_average < 1 %}#90EE90{% elif stock.peg_average <= 2 %}#ffd700{% else %}#ff6b6b{% endif %};">
                            {{ "%.2f"|format(stock.peg_average) }}
                        </span>
                    {% else %}
                        N/A
                    {% endif %}
                </td>
                <td>{{ stock.revenue_growth|format_percent }}</td>
                <td><span class="risk-badge risk-{{ stock.risk_level|lower|replace(' ', '-') }}">{{ stock.risk_level }}</span></td>
                <td>{{ stock.added_date }}</td>
                <td class="notes-cell">
                    <div class="notes-display" data-ticker="{{ stock.ticker }}">
                        <span class="notes-text">{{ stock.notes or 'Click to add note...' }}</span>
                        <button class="btn-edit-note" onclick="editNote('{{ stock.ticker }}', `{{ stock.notes or '' }}`)">✏️</button>
                    </div>
                    <div class="notes-edit" data-ticker="{{ stock.ticker }}" style="display: none;">
                        <textarea class="notes-textarea" rows="2">{{ stock.notes or '' }}</textarea>
                        <div class="notes-actions">
                            <button class="btn btn-sm btn-primary" onclick="saveNote('{{ stock.ticker }}')">Save</button>
                            <button class="btn btn-sm btn-secondary" onclick="cancelEdit('{{ stock.ticker }}')">Cancel</button>
                        </div>
                    </div>
                </td>
                <td>
                    <form method="POST" action="{{ url_for('remove_from_watchlist', ticker=stock.ticker) }}" style="display: inline;">
                        <button type="submit" class="btn btn-sm btn-danger">Remove</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<p class="no-results">Your watchlist is empty. Add stocks from the <a href="{{ url_for('screener') }}">screener</a>.</p>
{% endif %}

<style>
/* Notes cell styling */
.notes-cell {
    min-width: 200px;
    max-width: 300px;
}

.notes-display {
    display: flex;
    align-items: center;
    gap: 8px;
}

.notes-text {
    flex: 1;
    word-wrap: break-word;
    font-size: 0.9em;
    color: #e0e6ed;
}

.notes-text:empty::before {
    content: 'Click to add note...';
    color: #a8b2d1;
    font-style: italic;
}

.btn-edit-note {
    background: rgba(0, 255, 136, 0.1);
    border: 1px solid rgba(0, 255, 136, 0.3);
    color: #00ff88;
    border-radius: 4px;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 0.9em;
    transition: all 0.2s;
}

.btn-edit-note:hover {
    background: rgba(0, 255, 136, 0.2);
    box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
}

.notes-textarea {
    width: 100%;
    padding: 8px;
    background: rgba(10, 14, 39, 0.6);
    color: #e0e6ed;
    border: 2px solid rgba(0, 255, 136, 0.3);
    border-radius: 4px;
    font-family: inherit;
    font-size: 0.9em;
    resize: vertical;
}

.notes-textarea:focus {
    outline: none;
    border-color: #00ff88;
    box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
}

.notes-actions {
    display: flex;
    gap: 8px;
    margin-top: 8px;
}

/* Ranking select styling */
.ranking-select {
    background: rgba(10, 14, 39, 0.6);
    color: #e0e6ed;
    border: 2px solid rgba(0, 255, 136, 0.3);
    border-radius: 4px;
    padding: 6px 10px;
    font-size: 0.9em;
    cursor: pointer;
    transition: all 0.2s;
    min-width: 120px;
}

.ranking-select:hover {
    border-color: #00ff88;
}

.ranking-select:focus {
    outline: none;
    border-color: #00ff88;
    box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
}

/* Make sure stars display properly */
.ranking-select option {
    background: #1a1d2e;
    color: #e0e6ed;
}
</style>

<script>
// Edit note
function editNote(ticker, currentNotes) {
    const row = document.querySelector(`tr[data-ticker="${ticker}"]`);
    const display = row.querySelector('.notes-display');
    const edit = row.querySelector('.notes-edit');
    const textarea = edit.querySelector('.notes-textarea');

    // Unescape HTML entities in the current notes
    const parser = new DOMParser();
    const decoded = parser.parseFromString(currentNotes, 'text/html').body.textContent;

    textarea.value = decoded || '';
    display.style.display = 'none';
    edit.style.display = 'block';
    textarea.focus();
}

// Save note
function saveNote(ticker) {
    const row = document.querySelector(`tr[data-ticker="${ticker}"]`);
    const textarea = row.querySelector('.notes-textarea');
    const notes = textarea.value;

    fetch(`/watchlist/update-notes/${ticker}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ notes: notes })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update display
            const display = row.querySelector('.notes-display');
            const edit = row.querySelector('.notes-edit');
            const notesText = display.querySelector('.notes-text');

            notesText.textContent = notes || 'Click to add note...';
            display.style.display = 'flex';
            edit.style.display = 'none';
        } else {
            alert('Failed to save note: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to save note');
    });
}

// Cancel edit
function cancelEdit(ticker) {
    const row = document.querySelector(`tr[data-ticker="${ticker}"]`);
    const display = row.querySelector('.notes-display');
    const edit = row.querySelector('.notes-edit');

    display.style.display = 'flex';
    edit.style.display = 'none';
}

// Update ranking
function updateRanking(ticker, ranking) {
    fetch(`/watchlist/update-ranking/${ticker}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ ranking: parseInt(ranking) })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            alert('Failed to update ranking: ' + (data.error || 'Unknown error'));
            // Reload page to reset select
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update ranking');
        // Reload page to reset select
        location.reload();
    });
}
</script>
{% endblock %}
